<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Registro de Cliente</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --primary:#4A90E2; --bg:#f5f8fb; --card:#fff; --text:#333; --border:#dfe6ee; --hover:#3b7dc4; --error:#d84a4a;
  }
  *{box-sizing:border-box}
  body{
    font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    background:var(--bg); margin:0; min-height:100vh;
    display:flex; align-items:center; justify-content:center;
  }
  .container{
    width:100%; max-width:420px; background:var(--card); padding:28px 22px;
    border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.08);
    text-align:left;
  }
  h2{margin:0 0 20px; text-align:center; color:var(--primary)}
  .row{display:flex; gap:10px; align-items:center}
  .row > *{flex:1}
  .input-group{margin-bottom:16px}
  label{display:block; font-weight:600; color:var(--text); margin-bottom:6px}
  input,select{
    width:100%; padding:11px 12px; border:1px solid var(--border);
    border-radius:10px; font-size:15px; background:#fdfdfd
  }
  input:focus,select:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(74,144,226,.15)}
  .error{font-size:12px; color:var(--error); margin-top:6px; display:none}
  button{
    width:100%; background:var(--primary); color:#fff; border:0;
    padding:12px; font-size:16px; font-weight:600; border-radius:10px;
    cursor:pointer; transition:background-color .25s ease; margin-top:6px
  }
  button:hover{background:var(--hover)}
  button:disabled{opacity:.6; cursor:not-allowed}

  /* Modal */
  .modal-overlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); backdrop-filter:blur(3px); z-index:10; align-items:center; justify-content:center}
  .modal-overlay.show{display:flex}
  .modal{background:#fff; width:min(92%,380px); padding:22px 18px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.2)}
  .modal h3{margin:0; color:var(--primary)}
  .modal p{white-space:pre-line; margin:14px 0; color:#333}
  .button-group{display:flex; gap:12px}
  .button-group button{flex:1; border:0; padding:10px; font-weight:600; border-radius:10px; cursor:pointer}
  .button-group button:first-child{background:var(--primary); color:#fff}
  .button-group button:last-child{background:#e0e6ed; color:#333}
</style>
</head>
<body>
  <div class="container">
    <h2>Registrar Cliente</h2>

    <div class="input-group">
      <label for="nombre">Nombre completo</label>
      <input id="nombre" type="text" placeholder="Ej. Juan Pérez" autocomplete="name" />
      <div id="nombreMsg" class="error">Ingresa un nombre válido (mín. 4 letras, solo letras y espacios).</div>
    </div>

    <div class="input-group">
      <label for="username">Usuario de Telegram (sin @)</label>
      <input id="username" type="text" placeholder="Ej. juan_perez" inputmode="latin" autocapitalize="off" autocomplete="username" />
      <div id="usernameMsg" class="error">Username inválido. Usa 5–32 caracteres [a-z, 0-9, _], sin @.</div>
    </div>

    <div class="input-group">
      <label for="countryCode">Teléfono (con código de país)</label>
      <div class="row">
        <select id="countryCode">
          <option value="+54">Argentina (+54)</option>
          <option value="+591" selected>Bolivia (+591)</option>
          <option value="+55">Brasil (+55)</option>
          <option value="+56">Chile (+56)</option>
          <option value="+57">Colombia (+57)</option>
          <option value="+593">Ecuador (+593)</option>
          <option value="+592">Guyana (+592)</option>
          <option value="+595">Paraguay (+595)</option>
          <option value="+51">Perú (+51)</option>
          <option value="+597">Surinam (+597)</option>
          <option value="+598">Uruguay (+598)</option>
          <option value="+58">Venezuela (+58)</option>
        </select>
        <input id="telefono" type="tel" placeholder="Número local (solo dígitos)" autocomplete="tel" />
      </div>
      <div id="telefonoMsg" class="error">Número inválido para el país seleccionado.</div>
    </div>

    <button id="registrarBtn" disabled>Registrar</button>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Confirmar</h3>
      <p id="summaryText"></p>
      <div class="button-group">
        <button id="confirmYes">Sí</button>
        <button id="confirmNo">No</button>
      </div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp; if (tg){ tg.ready(); tg.expand(); }

  const $ = sel => document.querySelector(sel);
  const nombre = $('#nombre');
  const username = $('#username');
  const countryCode = $('#countryCode');
  const telefono = $('#telefono');
  const nombreMsg = $('#nombreMsg');
  const usernameMsg = $('#usernameMsg');
  const telefonoMsg = $('#telefonoMsg');
  const btn = $('#registrarBtn');
  const modalOverlay = $('#modalOverlay');
  const summaryText = $('#summaryText');
  const confirmYes = $('#confirmYes');
  const confirmNo = $('#confirmNo');

  const isValidNombre = (v) => {
    const s = v.trim();
    return s.length >= 4 && /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ' ]+$/.test(s);
  };
  const sanitizeUsername = (v) => v.trim().replace(/^@+/, '');
  const isValidUsername = (v) => /^[A-Za-z0-9_]{5,32}$/.test(sanitizeUsername(v));

  const onlyDigits = (v) => v.replace(/\D/g, '');
  function isValidPhone(country, localNumber) {
    const digits = onlyDigits(localNumber);
    if (country === '+591') return /^[2-7]\d{7}$/.test(digits);
    return /^\d{6,14}$/.test(digits);
  }

  function setBorder(el, ok){ if(!el) return; el.style.borderColor = ok ? 'var(--border)' : 'var(--error)'; }
  function setFieldState(inputEl, msgEl, isValid) {
    if (isValid) {
      inputEl?.setAttribute('aria-invalid', 'false');
      msgEl.style.display = 'none';
      setBorder(inputEl, true);
    } else {
      inputEl?.setAttribute('aria-invalid', 'true');
      msgEl.style.display = 'block';
      setBorder(inputEl, false);
    }
  }

  function validateAll() {
    const okNombre = isValidNombre(nombre.value);
    const okUser = isValidUsername(username.value);
    const okTel  = isValidPhone(countryCode.value, telefono.value);

    setFieldState(nombre, nombreMsg, okNombre);
    setFieldState(username, usernameMsg, okUser);
    setFieldState(telefono, telefonoMsg, okTel);

    btn.disabled = !(okNombre && okUser && okTel);
    return okNombre && okUser && okTel;
  }

  ['input','blur','change'].forEach(evt => {
    [nombre, username, telefono, countryCode].forEach(el => el.addEventListener(evt, validateAll));
  });

  validateAll();

  const openModal = (txt) => {
    summaryText.textContent = txt;
    modalOverlay.classList.add('show');
    modalOverlay.setAttribute('aria-hidden', 'false');
  };
  const closeModal = () => {
    modalOverlay.classList.remove('show');
    modalOverlay.setAttribute('aria-hidden', 'true');
  };
  confirmNo.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  btn.addEventListener('click', () => {
    if (!validateAll()) return;

    const lines = [
      `Nombre: ${nombre.value.trim()}`,
      `Usuario: ${sanitizeUsername(username.value)}`,
      `Teléfono: ${countryCode.value + onlyDigits(telefono.value)}`
    ];

    openModal(lines.join('\n'));
  });

  confirmYes.addEventListener('click', () => {
    const payload = {
      tipo: 'registro_cliente_ref',
      nombre: nombre.value.trim(),
      username: sanitizeUsername(username.value),
      telefono: countryCode.value + onlyDigits(telefono.value)
    };

    if (tg?.sendData) {
      tg.sendData(JSON.stringify(payload));
    } else {
      alert('Payload:\n' + JSON.stringify(payload, null, 2));
    }
    closeModal();
  });
</script>
</body>
</html>
