<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Registro de Usuario</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --primary:#4A90E2; --bg:#f5f8fb; --card:#fff; --text:#333; --border:#dfe6ee; --hover:#3b7dc4; --error:#d84a4a;
  }
  *{box-sizing:border-box}
  body{
    font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    background:var(--bg); margin:0; min-height:100vh;
    display:flex; align-items:center; justify-content:center;
  }
  .container{
    width:100%; max-width:420px; background:var(--card); padding:28px 22px;
    border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.08);
    text-align:left;
  }
  h2{margin:0 0 20px; text-align:center; color:var(--primary)}
  .row{display:flex; gap:10px; align-items:center}
  .row > *{flex:1}
  .input-group{margin-bottom:16px}
  label{display:block; font-weight:600; color:var(--text); margin-bottom:6px}
  input,select{
    width:100%; padding:11px 12px; border:1px solid var(--border);
    border-radius:10px; font-size:15px; background:#fdfdfd
  }
  input:focus,select:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(74,144,226,.15)}
  .error{font-size:12px; color:var(--error); margin-top:6px; display:none}
  button{
    width:100%; background:var(--primary); color:#fff; border:0;
    padding:12px; font-size:16px; font-weight:600; border-radius:10px;
    cursor:pointer; transition:background-color .25s ease; margin-top:6px
  }
  button:hover{background:var(--hover)}
  button:disabled{opacity:.6; cursor:not-allowed}
  .hidden{display:none!important}

  /* Modal */
  .modal-overlay{
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);
    backdrop-filter:blur(3px); z-index:10; align-items:center; justify-content:center
  }
  .modal-overlay.show{display:flex}
  .modal{
    background:#fff; width:min(92%,380px); padding:22px 18px;
    border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.2)
  }
  .modal h3{margin:0; color:var(--primary)}
  .modal p{white-space:pre-line; margin:14px 0; color:#333}
  .button-group{display:flex; gap:12px}
  .button-group button{
    flex:1; border:0; padding:10px; font-weight:600;
    border-radius:10px; cursor:pointer
  }
  .button-group button:first-child{background:var(--primary); color:#fff}
  .button-group button:last-child{background:#e0e6ed; color:#333}
</style>
</head>
<body>
  <div class="container">
    <h2 id="titulo">Registrar Usuario</h2>

    <!-- Nombre completo (siempre) -->
    <div class="input-group" id="grpNombre">
      <label for="nombre">Nombre completo</label>
      <input id="nombre" type="text" placeholder="Ej. Juan Pérez" autocomplete="name" />
      <div id="nombreMsg" class="error">Ingresa un nombre válido (mín. 4 letras, solo letras y espacios).</div>
    </div>

    <!-- Teléfono con código de país (condicional) -->
    <div class="input-group hidden" id="grpTelefono">
      <label for="telefono">Teléfono (con código de país)</label>
      <div class="row">
        <select id="countryCode">
          <option value="+591" selected>Bolivia (+591)</option>
          <option value="+54">Argentina (+54)</option>
          <option value="+51">Perú (+51)</option>
          <option value="+56">Chile (+56)</option>
          <option value="+57">Colombia (+57)</option>
          <option value="+34">España (+34)</option>
          <option value="+1">EE. UU. / Canadá (+1)</option>
          <option value="+55">Brasil (+55)</option>
          <option value="+598">Uruguay (+598)</option>
          <option value="+52">México (+52)</option>
        </select>
        <input id="telefono" type="tel" placeholder="Número local (solo dígitos)" autocomplete="tel" />
      </div>
      <div id="telefonoMsg" class="error">Número inválido para el país seleccionado.</div>
    </div>

    <!-- Referidor (condicional, siempre con opción "Ninguno") -->
    <div class="input-group hidden" id="grpReferidor">
      <label for="referidorSelect">Referidor</label>
      <select id="referidorSelect"></select>
      <div id="referidorMsg" class="error">Selecciona un referidor de la lista.</div>
    </div>

    <button id="registrarBtn" disabled>Registrar</button>
  </div>

  <!-- Modal de confirmación -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Confirmar</h3>
      <p id="summaryText"></p>
      <div class="button-group">
        <button id="confirmYes">Sí</button>
        <button id="confirmNo">No</button>
      </div>
    </div>
  </div>

<script>
  // Telegram WebApp init
  const tg = window.Telegram?.WebApp; 
  if (tg){ tg.ready(); tg.expand(); }

  // Helpers DOM
  const $ = sel => document.querySelector(sel);
  const titulo = $('#titulo');
  const grpTelefono = $('#grpTelefono');
  const grpReferidor = $('#grpReferidor');
  const nombre = $('#nombre');
  const nombreMsg = $('#nombreMsg');
  const countryCode = $('#countryCode');
  const telefono = $('#telefono');
  const telefonoMsg = $('#telefonoMsg');
  const referidorSelect = $('#referidorSelect');
  const referidorMsg = $('#referidorMsg');
  const btn = $('#registrarBtn');
  const modalOverlay = $('#modalOverlay');
  const summaryText = $('#summaryText');
  const confirmYes = $('#confirmYes');
  const confirmNo = $('#confirmNo');

  // URL params -> nombreBot, solicitarTelefono, solicitarReferidor, referidores
  const params = new URLSearchParams(location.search);
  const getParam = (k) => params.get(k);

  // boolish parser
  function toBoolish(v){
    if (v == null) return false;
    const s = String(v).trim().toLowerCase();
    if (s === '') return false;
    return ['1','true','sí','si','yes','y'].includes(s);
  }

  // Read params
  const tituloParam = getParam('nombreBot') || getParam('NombreBot') || '';
  const solicitarTelefono = toBoolish(getParam('solicitarTelefono') ?? getParam('SolicitarTelefono'));
  const solicitarReferidor = toBoolish(getParam('SolicitarReferidor') ?? getParam('solicitarReferidor'));

  // Lista de referidores (puede venir vacía)
  const referidoresParam = getParam('referidores') || getParam('Referidores') || '';
  let referidoresLista = [];

  if (referidoresParam) {
    // 1) Intentar parsear como JSON: ["user1","user2"]
    try {
      const parsed = JSON.parse(referidoresParam);
      if (Array.isArray(parsed)) {
        referidoresLista = parsed
          .map(x => String(x).trim())
          .filter(x => x.length > 0);
      }
    } catch {
      // 2) Si no es JSON, tomar como CSV: user1,user2,user3
      referidoresLista = referidoresParam
        .split(',')
        .map(x => decodeURIComponent(x.trim()))
        .filter(x => x.length > 0);
    }
  }

  if (tituloParam) titulo.textContent = tituloParam;

  // Show/hide conditional groups
  function setVisible(el, on){ el.classList.toggle('hidden', !on); }
  setVisible(grpTelefono, solicitarTelefono);
  setVisible(grpReferidor, solicitarReferidor);

  // Inicializar select de referidores (siempre agrega "Ninguno")
  function initReferidorSelect() {
    if (!solicitarReferidor || grpReferidor.classList.contains('hidden') || !referidorSelect) return;

    referidorSelect.innerHTML = '';

    // Opción "Ninguno" SIEMPRE presente
    const optNone = document.createElement('option');
    optNone.value = '';
    optNone.textContent = 'Ninguno';
    referidorSelect.appendChild(optNone);

    // Si hay referidores → agregarlos
    if (referidoresLista && referidoresLista.length > 0) {
      referidoresLista.forEach(ref => {
        const opt = document.createElement('option');
        opt.value = ref;
        opt.textContent = ref;
        referidorSelect.appendChild(opt);
      });
    }

    // Seleccionar por defecto "Ninguno"
    referidorSelect.value = '';
  }

  initReferidorSelect();

  // Validators
  const isValidNombre = (v) => {
    const s = v.trim();
    return s.length >= 4 && /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ' ]+$/.test(s);
  };

  const onlyDigits = (v) => v.replace(/\D/g, '');
  function isValidPhone(country, localNumber) {
    const digits = onlyDigits(localNumber);
    if (country === '+591') return /^[2-7]\d{7}$/.test(digits); // Bolivia: 8 dígitos
    return /^\d{6,14}$/.test(digits);                           // genérico
  }

  function setFieldState(inputEl, msgEl, ok) {
    if (!inputEl) return;
    if (ok) {
      inputEl.setAttribute('aria-invalid', 'false');
      msgEl && (msgEl.style.display = 'none');
      inputEl.style.borderColor = 'var(--border)';
    } else {
      inputEl.setAttribute('aria-invalid', 'true');
      msgEl && (msgEl.style.display = 'block');
      inputEl.style.borderColor = 'var(--error)';
    }
  }

  function validateAll(){
    let ok = true;

    // Nombre
    const okNombre = isValidNombre(nombre.value);
    setFieldState(nombre, nombreMsg, okNombre); 
    ok = ok && okNombre;

    // Teléfono
    if (solicitarTelefono && !grpTelefono.classList.contains('hidden')) {
      const okTel = isValidPhone(countryCode.value, telefono.value);
      setFieldState(telefono, telefonoMsg, okTel); 
      ok = ok && okTel;
    } else {
      setFieldState(telefono, telefonoMsg, true);
    }

    // Referidor (select): siempre válido porque "Ninguno" es opción válida
    if (solicitarReferidor && !grpReferidor.classList.contains('hidden')) {
      setFieldState(referidorSelect, referidorMsg, true);
      ok = ok && true;
    } else {
      setFieldState(referidorSelect, referidorMsg, true);
    }

    btn.disabled = !ok;
    return ok;
  }

  ['input','blur','change'].forEach(evt => {
    [nombre, telefono, countryCode, referidorSelect].forEach(el => el && el.addEventListener(evt, validateAll));
  });

  // Modal helpers
  const openModal = (txt) => {
    summaryText.textContent = txt; 
    modalOverlay.classList.add('show'); 
    modalOverlay.setAttribute('aria-hidden','false');
  };
  const closeModal = () => {
    modalOverlay.classList.remove('show'); 
    modalOverlay.setAttribute('aria-hidden','true');
  };
  confirmNo.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  // Click registrar -> resumen y confirmación
  btn.addEventListener('click', () => {
    if (!validateAll()) return;

    const lines = [ `Nombre: ${nombre.value.trim()}` ];

    if (solicitarTelefono && !grpTelefono.classList.contains('hidden')) {
      lines.push(`Teléfono: ${countryCode.value + onlyDigits(telefono.value)}`);
    }

    if (solicitarReferidor && !grpReferidor.classList.contains('hidden')) {
      const valRef = referidorSelect.value;
      if (valRef === '') {
        lines.push('Referidor: Ninguno');
      } else {
        lines.push(`Referidor: ${valRef}`);
      }
    }

    openModal(lines.join('\n'));
  });

  // Enviar al bot
  confirmYes.addEventListener('click', () => {
    const refVal = (solicitarReferidor && !grpReferidor.classList.contains('hidden'))
      ? (referidorSelect.value || null)   // "" -> null (Ninguno)
      : null;

    const payload = {
      tipo: 'autoregistro',
      nombre: nombre.value.trim(),
      telefono: (solicitarTelefono && !grpTelefono.classList.contains('hidden'))
        ? (countryCode.value + onlyDigits(telefono.value))
        : null,
      referidor: refVal
    };

    if (tg?.sendData) {
      tg.sendData(JSON.stringify(payload));
    } else {
      alert('Payload:\n' + JSON.stringify(payload, null, 2));
    }
    closeModal();
  });

  // Primera validación
  validateAll();
</script>
</body>
</html>
