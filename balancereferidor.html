<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ganancias</title>

<style>
:root{
  --bg:#0c0f14;
  --card:#141821;
  --ink:#e5e7eb;
  --muted:#9aa3b2;
  --line:#232836;

  --accent:#6b7280;   /* único acento sobrio */
  --ok:#22c55e;
  --bad:#ef4444;
  --warn:#f59e0b;
}

html,body{
  margin:0;height:100%;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
}

.wrap{max-width:880px;margin:auto;padding:20px}

.header{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  padding:18px;
  display:flex;
  gap:14px;
}

.avatar{
  width:44px;height:44px;
  border-radius:10px;
  background:#1f2432;
  display:grid;
  place-items:center;
  font-weight:600;
  color:#d1d5db;
}

.h-title{margin:0;font-size:17px}
.h-sub{margin:4px 0 0;font-size:13px;color:var(--muted)}

.tabs{
  margin-top:10px;
  display:flex;
  gap:14px;
}

.tab{
  font-size:13px;
  color:var(--muted);
  cursor:pointer;
  padding-bottom:4px;
  border-bottom:2px solid transparent;
}

.tab.active{
  color:var(--ink);
  border-color:var(--accent);
}

.pill{
  font-size:12px;
  color:var(--muted);
  border:1px solid var(--line);
  padding:6px 10px;
  border-radius:999px;
}

.cards{
  display:grid;
  gap:16px;
  margin-top:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
}

.card h3{
  margin:0;
  padding:14px 16px;
  font-size:14px;
  border-bottom:1px solid var(--line);
  color:#d1d5db;
}

.pad{padding:14px 16px}

.kpis{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
@media(min-width:760px){.kpis{grid-template-columns:repeat(4,1fr)}}

.kpi{
  background:#10141c;
  border:1px solid var(--line);
  border-radius:10px;
  padding:12px;
}

.kpi .label{
  font-size:12px;
  color:var(--muted);
}

.kpi .val{
  font-size:17px;
  font-weight:600;
  margin-top:4px;
}

.kpi.pos .val{color:var(--ok)}
.kpi.neg .val{color:var(--bad)}

table{width:100%;border-collapse:separate;border-spacing:0 10px}

.row{
  background:#10141c;
  border:1px solid var(--line);
  border-radius:10px;
}

td{padding:10px 12px}

td.key{
  color:var(--muted);
  width:55%;
}

td.val{
  font-weight:600;
}

.val.ok{color:var(--ok)}
.val.bad{color:var(--bad)}
.val.warn{color:var(--warn)}

.badge{
  font-size:11px;
  padding:2px 6px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
}
</style>
</head>

<body>
<div class="wrap">

  <section class="header">
    <div class="avatar" id="avatarTxt">CL</div>
    <div>
      <h1 class="h-title">Ganancias</h1>
      <p class="h-sub">
        <span id="personaName">—</span> ·
        <span id="rangoFechas">—</span>
      </p>

      <div class="tabs">
        <div class="tab active" id="tab-curr">Periodo actual</div>
        <div class="tab" id="tab-prev">Mes anterior</div>
      </div>
    </div>

    <div style="margin-left:auto">
      <span class="pill" id="rangoTxt">Rango: —</span>
    </div>
  </section>

  <section class="cards">

    <article class="card">
      <h3>Resumen</h3>
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><div class="label">Cargas</div><div class="val" id="kpiCargas"></div></div>
          <div class="kpi"><div class="label">Retiros</div><div class="val" id="kpiRetiros"></div></div>
          <div class="kpi" id="kpiBalanceBox"><div class="label">Balance</div><div class="val" id="kpiBalance"></div></div>
          <div class="kpi"><div class="label">Comisión</div><div class="val" id="kpiComi"></div></div>
        </div>
      </div>
    </article>

    <article class="card">
      <h3>Detalle de cálculo</h3>
      <div class="pad">
        <table>
          <tbody id="tablaCalculo"></tbody>
        </table>
      </div>
    </article>

  </section>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);

  // Normaliza números en distintos formatos: 1.234,56 / 1,234.56 / 1234,56 / 1234.56
  const getN = k => {
    const v = qs.get(k);
    if (!v) return 0;
    const s = String(v).trim();
    const hasComma = s.includes(',');
    const hasDot = s.includes('.');
    let cleaned = s;

    if (hasComma && hasDot) {
      const lastComma = s.lastIndexOf(',');
      const lastDot = s.lastIndexOf('.');
      if (lastComma > lastDot) {
        cleaned = s.replace(/\./g, '').replace(',', '.'); // coma decimal, punto miles
      } else {
        cleaned = s.replace(/,/g, ''); // punto decimal, coma miles
      }
    } else if (hasComma) {
      cleaned = s.replace(/\./g, '').replace(',', '.'); // solo coma -> decimal
    } else {
      cleaned = s.replace(/,/g, ''); // solo punto o ninguno
    }
    const n = Number(cleaned);
    return isNaN(n) ? 0 : n;
  };

  const getS = (k,f="—") => {
    const v = qs.get(k); return (!v) ? f : decodeURIComponent(v);
  };

  const fmt = new Intl.NumberFormat('es-BO',{minimumFractionDigits:2, maximumFractionDigits:2});

  // dd/MM/yyyy fijo
  const fmtFecha = (txt)=>{
    if(!txt || txt==="—") return "—";
    const d = new Date(txt);
    if(!isNaN(d.getTime())){
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    const m = txt.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
    if(m) return `${m[1]}/${m[2]}/${m[3]}`;
    return txt;
  };

  // Datos período actual
  const dataCurr = {
    persona: getS('persona'),
    fechaIni: fmtFecha(getS('fechaInicio')),
    fechaFin: fmtFecha(getS('fechaFin')),
    cargas: getN('cargas'),
    retiros: getN('retiros'),
    rangoNombre: getS('rangoNombre'),
    rangoComision: getN('rangoComision'),
    pagoSinDescuento: getN('pagoSinDescuento'),
    prorrateoNegativo: getN('prorrateoNegativo'),
    descuento: getN('descuento'),
    subTotal: getN('subTotal')
  };
  dataCurr.balance = Number((dataCurr.cargas - dataCurr.retiros).toFixed(2));

  // Datos mes anterior
  const dataPrev = {
    persona: getS('persona') || '—',
    fechaIni: fmtFecha(getS('fechaInicioPrev')),
    fechaFin: fmtFecha(getS('fechaFinPrev')),
    cargas: getN('cargasPrev'),
    retiros: getN('retirosPrev'),
    rangoNombre: getS('rangoNombre'),
    rangoComision: getN('rangoComision'),
    pagoSinDescuento: getN('pagoSinDescuentoPrev'),
    prorrateoNegativo: getN('prorrateoNegativoPrev'),
    descuento: getN('descuentoPrev'),
    subTotal: getN('subTotalPrev')
  };
  dataPrev.balance = Number((dataPrev.cargas - dataPrev.retiros).toFixed(2));

  // UI refs
  const avatarTxt = document.getElementById('avatarTxt');
  const personaName = document.getElementById('personaName');
  const rangoFechas = document.getElementById('rangoFechas');
  const rangoTxt = document.getElementById('rangoTxt');
  const kpiCargas = document.getElementById('kpiCargas');
  const kpiRetiros = document.getElementById('kpiRetiros');
  const kpiBalance = document.getElementById('kpiBalance');
  const kpiBalanceBox = document.getElementById('kpiBalanceBox');
  const kpiComi = document.getElementById('kpiComi');
  const tbody = document.getElementById('tablaCalculo');
  const tabCurr = document.getElementById('tab-curr');
  const tabPrev = document.getElementById('tab-prev');

  const setTabState = (which)=>{
    tabCurr.classList.toggle('active', which==='curr');
    tabPrev.classList.toggle('active', which==='prev');
    tabCurr.setAttribute('aria-selected', which==='curr' ? 'true':'false');
    tabPrev.setAttribute('aria-selected', which==='prev' ? 'true':'false');
  };

  // Limpia KPIs y tabla para evitar restos de la vista anterior
  function resetUI() {
    kpiCargas.innerHTML = '';
    kpiRetiros.innerHTML = '';
    kpiBalance.innerHTML = '';
    kpiBalanceBox.classList.remove('pos','neg');
    tbody.replaceChildren();
  }

  // Renderizado
  // IMPORTANTE: showDeltas = false en ambas vistas para que "Periodo actual" NO muestre nada del mes anterior.
  const render = (data, compare=null, showDeltas=false)=>{
    resetUI();

    // Header
    const iniciales = data.persona && data.persona!=='—'
      ? data.persona.split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('')
      : 'CL';
    avatarTxt.textContent = iniciales;
    personaName.textContent = data.persona || '—';
    rangoFechas.textContent = `${data.fechaIni || '—'} – ${data.fechaFin || '—'}`;
    rangoTxt.textContent = `Rango: ${data.rangoNombre || '—'} (${fmt.format(data.rangoComision||0)}%)`;

    const setWithDelta = (el, val, prevVal)=>{
      el.textContent = `Bs ${fmt.format(val||0)}`;
      if(showDeltas && prevVal!=null){
        const diff = Number(((val||0) - (prevVal||0)).toFixed(2));
        if(diff !== 0){
          const span = document.createElement('span');
          span.className = 'delta ' + (diff>0?'up':diff<0?'down':'');
          const sign = diff>0?'+':diff<0?'-':'';
          span.textContent = ` ${sign}Bs ${fmt.format(Math.abs(diff))}`;
          el.appendChild(span);
        }
      }
    };

    // KPIs SIN comparación (compare = null) => no aparecen deltas.
    setWithDelta(kpiCargas, data.cargas, compare ? compare.cargas : null);
    setWithDelta(kpiRetiros, data.retiros, compare ? compare.retiros : null);
    kpiBalanceBox.classList.add((data.balance||0)>=0 ? 'pos':'neg');
    setWithDelta(kpiBalance, data.balance, compare ? compare.balance : null);
    kpiComi.textContent = `${fmt.format(data.rangoComision||0)}%`;

    // Tabla (solo datos del periodo seleccionado)
    const rows = [
      {k:'Balance base', v:data.balance, cls:(data.balance||0)>=0?'ok':'bad', hint:'(Cargas − Retiros)'},
      {k:`Comisión por rango (${fmt.format(data.rangoComision||0)}%)*`, v:data.pagoSinDescuento, cls:(data.pagoSinDescuento||0)>=0?'ok':'bad'},
      {k:'Prorrateo negativo', v:data.prorrateoNegativo, cls:(data.prorrateoNegativo||0)<0?'bad':'warn'},
      {k:'Descuento', v:-Math.abs(data.descuento||0), cls:'warn'},
      {k:'Pago neto (Subtotal)', v:data.subTotal, cls:(data.subTotal||0)>=0?'ok':'bad', strong:true}
    ];

    for(const r of rows){
      const tr = document.createElement('tr'); tr.className='row';
      const tdK = document.createElement('td'); tdK.className='key';
      tdK.innerHTML = r.k + (r.hint?` <span class="badge">${r.hint}</span>`:'');
      const tdV = document.createElement('td'); tdV.className='val';
      tdV.textContent = `Bs ${fmt.format(r.v||0)}`;
      if(r.cls) tdV.classList.add(r.cls);
      if(r.strong){ tdV.style.fontSize='20px'; tdV.style.fontWeight='800'; }
      tr.appendChild(tdK); tr.appendChild(tdV);
      tbody.appendChild(tr);
    }
  };

  // Vista inicial (?view=prev permite abrir directo el mes anterior)
  const initialView = (getS('view','curr').toLowerCase()==='prev') ? 'prev' : 'curr';
  setTabState(initialView);

  // IMPORTANTE: compare=null y showDeltas=false para que no se vea nada del mes anterior en el periodo actual.
  if(initialView==='curr') render(dataCurr, null, false);
  else render(dataPrev, null, false);

  // Eventos de pestañas
  tabCurr.addEventListener('click', ()=>{
    setTabState('curr');
    render(dataCurr, null, false); // NO compare
    history.replaceState(null,'',updateQuery('view','curr'));
  });
  tabPrev.addEventListener('click', ()=>{
    setTabState('prev');
    render(dataPrev, null, false); // NO compare
    history.replaceState(null,'',updateQuery('view','prev'));
  });

  function updateQuery(key, val){
    const url = new URL(location.href);
    url.searchParams.set(key, val);
    return url.toString();
  }
})();
</script>
</body>
</html>
