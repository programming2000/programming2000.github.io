<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ganancias</title>
<style>
  :root{
    --bg:#0e1116; --card:#151a22; --ink:#e8edf3; --muted:#aab3c2;
    --ok:#18b26a; --warn:#eab308; --bad:#ef4444; --accent:#4f8cff; --line:#233042;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  .wrap{max-width:880px;margin:auto;padding:20px;}
  .header{
    background:linear-gradient(135deg,#18212c 0%, #10161e 60%, #0e131a 100%);
    border:1px solid var(--line); border-radius:16px; padding:18px 20px;
    display:flex;align-items:center;gap:14px; box-shadow:0 8px 24px rgba(0,0,0,.25);
    min-width:0;
  }
  .avatar{width:46px;height:46px;border-radius:12px;background:radial-gradient(120% 120% at 30% 20%, #5daeff 0%, #4f8cff 35%, #1a5fff 70%, #0a2a6b 100%);display:grid;place-items:center;font-weight:700;color:white;box-shadow:0 6px 20px rgba(79,140,255,.35)}
  .head-main{min-width:0;flex:1 1 auto}
  .h-title{font-size:18px;margin:0;line-height:1.2}
  .h-sub{margin:2px 0 0;color:var(--muted);font-size:13px}
  #personaName{display:inline-block;max-width:55vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:bottom}
  @media(min-width:760px){#personaName{max-width:480px}}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0b1220;color:#b6c3d6;font-size:12px}
  .tabs{margin-top:12px;display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .tab{padding:8px 12px;cursor:pointer;background:#0b1220;color:#9fb5ff;border-right:1px solid var(--line);font-size:13px;user-select:none;white-space:nowrap}
  .tab:last-child{border-right:none}
  .tab.active{background:var(--accent);color:#fff}
  .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:16px}
  .card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.20);overflow:hidden}
  .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:15px;letter-spacing:.2px;background:#111722}
  .pad{padding:14px 16px}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(min-width:760px){.kpis{grid-template-columns:repeat(4,1fr)}}
  .kpi{background:#0f1622;border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi .label{color:var(--muted);font-size:12px}
  .kpi .val{font-weight:700;font-size:18px;margin-top:2px}
  .kpi.pos .val{color:var(--ok)} .kpi.neg .val{color:var(--bad)}
  .delta{display:inline-block;margin-left:6px;font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);color:#b6c3d6}
  .delta.up{color:var(--ok)} .delta.down{color:var(--bad)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  tbody tr{background:#0f1622}
  td{padding:10px 12px;vertical-align:middle}
  td.key{color:var(--muted);width:48%}
  td.val{font-weight:600}
  .row{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .val.bad{color:var(--bad)} .val.ok{color:var(--ok)} .val.warn{color:var(--warn)}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <section class="header">
    <div class="avatar" id="avatarTxt">CL</div>
    <div class="head-main">
      <h1 class="h-title">Ganancias hasta la fecha</h1>
      <p class="h-sub"><span id="personaName">—</span> · <span id="rangoFechas">—</span></p>
      <div class="tabs" role="tablist" aria-label="Período">
        <div class="tab" id="tab-curr" role="tab" aria-selected="true">Periodo actual</div>
        <div class="tab" id="tab-prev" role="tab" aria-selected="false">Mes anterior</div>
      </div>
    </div>
    <div style="margin-left:auto"><span class="pill"><span id="rangoTxt">Rango: —</span></span></div>
  </section>

  <section class="cards">
    <article class="card">
      <h3>Resumen</h3>
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><div class="label">Cargas</div><div class="val" id="kpiCargas">—</div></div>
          <div class="kpi"><div class="label">Retiros</div><div class="val" id="kpiRetiros">—</div></div>
          <div class="kpi" id="kpiBalanceBox"><div class="label">Balance (Cargas − Retiros)</div><div class="val" id="kpiBalance">—</div></div>
          <div class="kpi"><div class="label">Comisión de Rango</div><div class="val" id="kpiComi">—</div></div>
        </div>
      </div>
    </article>

    <article class="card">
      <h3>Detalle de cálculo</h3>
      <div class="pad">
        <table>
          <tbody id="tablaCalculo"></tbody>
        </table>
      </div>
    </article>
  </section>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);

  // ===== Parser robusto de números =====
  const getN = (k) => {
    const raw = qs.get(k);
    if (raw == null || raw === "") return 0;
    let v = String(raw).trim();
    const hasComma = v.includes(",");
    const hasDot = v.includes(".");
    if (hasComma && hasDot) {
      const lastComma = v.lastIndexOf(",");
      const lastDot = v.lastIndexOf(".");
      if (lastComma > lastDot) {
        // 1.234,56 -> 1234.56
        v = v.replace(/\./g, "").replace(",", ".");
      } else {
        // 1,234.56 -> 1234.56
        v = v.replace(/,/g, "");
      }
    } else if (hasComma) {
      // 1234,56 -> 1234.56
      v = v.replace(",", ".");
    } else {
      // Solo puntos como miles -> quita
      if (/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(raw)) v = v.replace(/\./g, "");
    }
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  };

  const getS = (k,f="—") => {
    const v = qs.get(k);
    return (!v) ? f : decodeURIComponent(v);
  };

  const fmt = new Intl.NumberFormat('es-BO',{minimumFractionDigits:2, maximumFractionDigits:2});

  // dd/MM/yyyy fijo (acepta ISO o dd/MM/yyyy o dd-MM-yyyy)
  const fmtFecha = (txt)=>{
    if(!txt || txt==="—") return "—";
    const d = new Date(txt);
    if(!isNaN(d.getTime())){
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    const m = txt.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
    if(m) return `${m[1]}/${m[2]}/${m[3]}`;
    return txt;
  };

  // Mostrar/ocultar “Mes anterior”
  const allowPrev = getS('abrirmesanterior','true').toLowerCase() === 'true';
  const tabPrev = document.getElementById('tab-prev');
  if(!allowPrev){ tabPrev.style.display = 'none'; }

  // ===== Datos período actual =====
  const dataCurr = {
    persona: getS('persona'),
    fechaIni: fmtFecha(getS('fechaInicio')),
    fechaFin: fmtFecha(getS('fechaFin')),
    cargas: getN('cargas'),
    retiros: getN('retiros'),
    rangoNombre: getS('rangoNombre'),
    rangoComision: getN('rangoComision'),
    pagoSinDescuento: getN('pagoSinDescuento'),
    prorrateoNegativo: getN('prorrateoNegativo'),
    descuento: getN('descuento'),
    subTotal: getN('subTotal')
  };
  dataCurr.balance = Number((dataCurr.cargas - dataCurr.retiros).toFixed(2));

  // ===== Datos mes anterior =====
  const dataPrev = {
    persona: dataCurr.persona,
    fechaIni: fmtFecha(getS('fechaInicioPrev')),
    fechaFin: fmtFecha(getS('fechaFinPrev')),
    cargas: getN('cargasPrev'),
    retiros: getN('retirosPrev'),
    rangoNombre: dataCurr.rangoNombre,
    rangoComision: dataCurr.rangoComision,
    pagoSinDescuento: getN('pagoSinDescuentoPrev'),
    prorrateoNegativo: getN('prorrateoNegativoPrev'),
    descuento: getN('descuentoPrev')
