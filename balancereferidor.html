using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Web;

public static class MiniAppLinkBuilder
{
    /// <summary>
    /// Genera el link para la MiniApp de ganancias con período actual y mes anterior.
    /// - fechaInicioPrev/fechaFinPrev se calculan como el primer y último día del mes anterior al de fechaInicio.
    /// - Si 'anterior' es null, igual se envían fechas previas, pero los montos prev se enviarán como 0.
    /// </summary>
    public static string GenerarLinkMiniApp(
        string baseUrl,
        string persona,
        DateTime fechaInicio,
        DateTime fechaFin,
        Modelo actual,
        Modelo anterior = null,
        bool abrirMesAnterior = false  // si true, agrega view=prev
    )
    {
        if (string.IsNullOrWhiteSpace(baseUrl))
            throw new ArgumentException("baseUrl no puede ser vacío.", nameof(baseUrl));
        if (actual == null)
            throw new ArgumentNullException(nameof(actual));

        // ---- Fechas (mes anterior) ----
        var prevStart = FirstDayOfPreviousMonth(fechaInicio);
        var prevEnd   = LastDayOfMonth(prevStart);

        // ---- Helpers ----
        string D(decimal v) => v.ToString(CultureInfo.InvariantCulture);    // decimales con '.' en la URL
        string F(DateTime d) => d.ToString("yyyy-MM-dd");                   // ISO simple para la URL
        string S(string s) => s ?? string.Empty;

        // Si no hay modelo 'anterior', usar 0 para sus campos numéricos
        var prev = anterior ?? new Modelo();

        // ---- Query params ----
        var q = HttpUtility.ParseQueryString(string.Empty);

        // Vista inicial (opcional)
        if (abrirMesAnterior) q["view"] = "prev";

        // Persona y fechas actuales
        q["persona"]     = persona;
        q["fechaInicio"] = F(fechaInicio);
        q["fechaFin"]    = F(fechaFin);

        // Datos período actual
        q["cargas"]             = D(actual.Cargas);
        q["retiros"]            = D(actual.Retiros);
        q["rangoNombre"]        = S(actual.RangoNombre);
        q["rangoComision"]      = D(actual.RangoComision);
        q["pagoSinDescuento"]   = D(actual.PagoSinDescuento);
        q["prorrateoNegativo"]  = D(actual.ProrrateoNegativo);
        q["descuento"]          = D(actual.Descuento);
        q["subTotal"]           = D(actual.SubTotal);

        // Fechas y datos del mes anterior
        q["fechaInicioPrev"]        = F(prevStart);
        q["fechaFinPrev"]           = F(prevEnd);
        q["cargasPrev"]             = D(prev.Cargas);
        q["retirosPrev"]            = D(prev.Retiros);
        q["pagoSinDescuentoPrev"]   = D(prev.PagoSinDescuento);
        q["prorrateoNegativoPrev"]  = D(prev.ProrrateoNegativo);
        q["descuentoPrev"]          = D(prev.Descuento);
        q["subTotalPrev"]           = D(prev.SubTotal);

        // Construir URL
        // Asegúrate que baseUrl ya apunte a ganancias.html (o el recurso que uses).
        var uriBuilder = new UriBuilder(baseUrl);
        uriBuilder.Query = q.ToString();

        return uriBuilder.ToString();
    }

    private static DateTime FirstDayOfPreviousMonth(DateTime reference)
    {
        var firstDayThisMonth = new DateTime(reference.Year, reference.Month, 1);
        return firstDayThisMonth.AddMonths(-1);
    }

    private static DateTime LastDayOfMonth(DateTime anyDayInMonth)
    {
        var firstNext = new DateTime(anyDayInMonth.Year, anyDayInMonth.Month, 1).AddMonths(1);
        return firstNext.AddDays(-1);
    }
}
