<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promociones</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --primary:#2F80ED;
      --bg:#F5F7FB;
      --card:#FFFFFF;
      --text:#1F2937;
      --muted:#6B7280;
      --border:#E5E7EB;
      --ok:#059669;
      --warn:#B45309;
      --bad:#B91C1C;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 880px;
      margin: 0 auto;
      padding: 16px;
    }

    .header{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom: 14px;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .title h1{
      font-size: 18px;
      margin:0;
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      background:#fff;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 12px;
    }

    @media (min-width: 820px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }

    .promoName{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .promoName .line1{
      font-weight:700;
      font-size: 14px;
      margin:0;
    }
    .promoName .line2{
      margin:0;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }

    .badge{
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid var(--border);
      background:#fff;
      color: var(--text);
      white-space: nowrap;
    }

    .table{
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
    }
    .row{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      background:#fff;
    }
    .row:first-child{ border-top:0; }
    .k{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.3;
    }
    .v{
      font-size: 12.5px;
      line-height: 1.35;
      color: var(--text);
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background: #fff;
    }

    .calc{
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      background: #fff;
    }
    .calcHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .calcHead .label{
      font-size: 12.5px;
      font-weight: 650;
    }
    .calcHead .hint{
      font-size: 12px;
      color: var(--muted);
    }

    .calcGrid{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap: 10px;
      align-items:center;
    }
    input{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      outline:none;
    }
    input:focus{
      border-color: rgba(47,128,237,.6);
      box-shadow: 0 0 0 3px rgba(47,128,237,.15);
    }
    button{
      border:0;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      cursor:pointer;
      background: var(--primary);
      color:#fff;
      font-weight: 650;
    }

    .calcOut{
      font-size: 12.5px;
      color: var(--text);
      line-height: 1.45;
    }
    .mono{ font-variant-numeric: tabular-nums; }

    .empty{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .small{ font-size: 12px; color: var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>Promociones disponibles</h1>
        <p>Revisa condiciones, plataformas aplicables y cálculo del regalo.</p>
      </div>
      <div class="pill" id="pillInfo">Cargando…</div>
    </div>

    <div id="content"></div>
  </div>

  <script>
    // Telegram WebApp init
    try {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    } catch { /* ignore if opened in browser */ }

    // Mapeo de IDs a nombres de plataforma
    const PLATAFORMAS = {
      1: "Apueston",
      2: "Metabet",
      3: "PPP US",
      4: "PPP SOL",
      5: "KKK",
      6: "PPP BOL",
      7: "GGG",
      8: "Tienda"
    };

    function platformName(id) {
      return PLATAFORMAS[id] ?? `Producto ${id}`;
    }

    function fmtMoney(n) {
      if (n === null || n === undefined || isNaN(Number(n))) return "—";
      // Ajusta a tu moneda; aquí solo formateo numérico
      return Number(n).toLocaleString("es-BO", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtPct(n) {
      if (n === null || n === undefined || isNaN(Number(n))) return "—";
      return `${Number(n).toLocaleString("es-BO", { maximumFractionDigits: 2 })}%`;
    }

    function parsePromosFromUrl() {
      const usp = new URLSearchParams(location.search);
      const raw = usp.get("promos");
      if (!raw) return [];
      try {
        const json = decodeURIComponent(raw);
        const arr = JSON.parse(json);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    /**
     * Reglas de finalización (interpretación operativa):
     * - Se define un "rango permitido de crédito final" para poder finalizar:
     *   - Umbral inferior (mínimo permitido):  MontoRequeridoFinalizar (o % de recarga)
     *   - Umbral superior (máximo permitido):  MontoMinimoFinalizar (o % de recarga)
     * - Si el crédito final del usuario está entre [inferior, superior], puede finalizar.
     *
     * Nota: Si te interesa otra lógica (por ejemplo, que uno de los dos sea opcional),
     * es fácil ajustarlo en canFinalize().
     */
    function computeFinalizeThresholds(promo, recarga) {
      const r = Number(recarga);
      const minFinalIsPct = !!promo.MontoMinimoFinalizarEsPorcentaje;
      const reqFinalIsPct = !!promo.MontoRequeridoFinalizarEsPorcentaje;

      let upper = Number(promo.MontoMinimoFinalizar);
      let lower = Number(promo.MontoRequeridoFinalizar);

      if (!isNaN(r)) {
        if (minFinalIsPct) upper = r * (Number(promo.MontoMinimoFinalizar) / 100);
        if (reqFinalIsPct) lower = r * (Number(promo.MontoRequeridoFinalizar) / 100);
      }

      return { lower, upper, lowerIsPct: reqFinalIsPct, upperIsPct: minFinalIsPct };
    }

    function giftAmount(promo, recarga) {
      const isPct = !!promo.MontoRegaloEsPorcentaje;
      if (!isPct) return Number(promo.MontoRegalo);
      const r = Number(recarga);
      if (isNaN(r)) return null;
      return r * (Number(promo.MontoRegalo) / 100);
    }

    function renderPromoCard(promo, idx) {
      const validIds = Array.isArray(promo.ProductosValidosId) ? promo.ProductosValidosId : [];
      const regaloId = Number(promo.ProductoRegaloId);

      const aplicaTxt = validIds.length
        ? validIds.map(platformName).join(", ")
        : "—";

      const regaloTxt = platformName(regaloId);

      // Textos de finalización (sin recarga)
      const upperTxt = promo.MontoMinimoFinalizarEsPorcentaje
        ? `${fmtPct(promo.MontoMinimoFinalizar)} o menos de lo recargado`
        : `${fmtMoney(promo.MontoMinimoFinalizar)} o menos`;

      const lowerTxt = promo.MontoRequeridoFinalizarEsPorcentaje
        ? `${fmtPct(promo.MontoRequeridoFinalizar)} o más de lo recargado`
        : `${fmtMoney(promo.MontoRequeridoFinalizar)} o más`;

      const regaloMontoTxt = promo.MontoRegaloEsPorcentaje
        ? `${fmtPct(promo.MontoRegalo)} de lo recargado`
        : `${fmtMoney(promo.MontoRegalo)}`;

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="cardTop">
          <div class="promoName">
            <p class="line1">Promo #${idx + 1}</p>
            <p class="line2">
              Inicia desde <span class="mono">${fmtMoney(promo.MontoMinimo)}</span>
              y el regalo se acredita en <b>${regaloTxt}</b>.
            </p>
          </div>
          <div class="badge">Regalo: <b>${regaloMontoTxt}</b></div>
        </div>

        <div class="table">
          <div class="row">
            <div class="k">Aplica a</div>
            <div class="v">
              <div class="chips">
                ${
                  validIds.length
                    ? validIds.map(id => `<span class="chip">${platformName(id)}</span>`).join("")
                    : `<span class="chip">—</span>`
                }
              </div>
              <div class="small" style="margin-top:6px">IDs: ${validIds.length ? validIds.join(", ") : "—"}</div>
            </div>
          </div>

          <div class="row">
            <div class="k">Monto mínimo para iniciar</div>
            <div class="v"><span class="mono">${fmtMoney(promo.MontoMinimo)}</span></div>
          </div>

          <div class="row">
            <div class="k">Condición para finalizar</div>
            <div class="v">
              Crédito final debe estar entre:
              <br />
              <b>• Mínimo permitido:</b> ${lowerTxt}
              <br />
              <b>• Máximo permitido:</b> ${upperTxt}
              <div class="small" style="margin-top:6px">
                (Interpretación operativa: si tu crédito final queda dentro del rango, puedes finalizar.)
              </div>
            </div>
          </div>

          <div class="row">
            <div class="k">Aclaración del regalo</div>
            <div class="v">
              ${
                promo.MontoRegaloEsPorcentaje
                  ? `El regalo equivale a un porcentaje de lo recargado y se acredita en <b>${regaloTxt}</b>.`
                  : `El regalo es un monto fijo y se acredita en <b>${regaloTxt}</b>.`
              }
            </div>
          </div>
        </div>

        <div class="calc">
          <div class="calcHead">
            <div class="label">Simulador (opcional)</div>
            <div class="hint">Ingresa la recarga para calcular porcentajes</div>
          </div>

          <div class="calcGrid">
            <input type="number" inputmode="decimal" placeholder="Monto recargado (ej: 100)" id="recarga_${idx}" />
            <button type="button" id="btn_${idx}">Calcular</button>
          </div>

          <div class="calcOut" id="out_${idx}">
            Si algún valor está en porcentaje, aquí verás su equivalente en monto.
          </div>
        </div>
      `;

      // Eventos
      const btn = card.querySelector(`#btn_${idx}`);
      btn.addEventListener("click", () => {
        const inp = card.querySelector(`#recarga_${idx}`);
        const recarga = Number(inp.value);

        const out = card.querySelector(`#out_${idx}`);

        if (isNaN(recarga) || recarga <= 0) {
          out.innerHTML = `<span style="color:var(--bad)">Ingresa un monto recargado válido mayor a 0.</span>`;
          return;
        }

        const { lower, upper } = computeFinalizeThresholds(promo, recarga);
        const regalo = giftAmount(promo, recarga);

        const upperLine = promo.MontoMinimoFinalizarEsPorcentaje
          ? `Máximo permitido: <b class="mono">${fmtMoney(upper)}</b> (por ${fmtPct(promo.MontoMinimoFinalizar)} de ${fmtMoney(recarga)})`
          : `Máximo permitido: <b class="mono">${fmtMoney(upper)}</b>`;

        const lowerLine = promo.MontoRequeridoFinalizarEsPorcentaje
          ? `Mínimo permitido: <b class="mono">${fmtMoney(lower)}</b> (por ${fmtPct(promo.MontoRequeridoFinalizar)} de ${fmtMoney(recarga)})`
          : `Mínimo permitido: <b class="mono">${fmtMoney(lower)}</b>`;

        const giftLine = promo.MontoRegaloEsPorcentaje
          ? `Regalo estimado: <b class="mono">${fmtMoney(regalo)}</b> (por ${fmtPct(promo.MontoRegalo)} de ${fmtMoney(recarga)})`
          : `Regalo: <b class="mono">${fmtMoney(regalo)}</b>`;

        out.innerHTML = `
          ${lowerLine}<br/>
          ${upperLine}<br/>
          ${giftLine}<br/>
          <span class="small">Recuerda: esto solo calcula umbrales en base a la recarga; la validación real depende del crédito final del usuario.</span>
        `;
      });

      return card;
    }

    function render(promos) {
      const pill = document.getElementById("pillInfo");
      const content = document.getElementById("content");

      const isTelegram = !!(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData);
      pill.textContent = isTelegram ? `Abierto en Telegram` : `Abierto en navegador`;

      if (!promos.length) {
        content.innerHTML = `
          <div class="empty">
            No se recibieron promociones.<br/><br/>
            Debes abrir la MiniApp con el parámetro <b>promos</b> (JSON codificado en URL).<br/>
            <span class="small">Ejemplo: ?promos=%5B...%5D</span>
          </div>
        `;
        return;
      }

      const grid = document.createElement("div");
      grid.className = "grid";
      promos.forEach((p, i) => grid.appendChild(renderPromoCard(p, i)));

      content.innerHTML = "";
      content.appendChild(grid);
    }

    // Ejecutar
    const promos = parsePromosFromUrl();
    render(promos);
  </script>
</body>
</html>
