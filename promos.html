<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promociones</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --shadow:0 10px 22px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{ max-width: 980px; margin:0 auto; padding: 16px; }

    .header{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      margin-bottom: 12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .header h1{ margin:0; font-size: 18px; letter-spacing:.2px; }
    .header p{ margin:6px 0 0; color:var(--muted); font-size: 13px; line-height: 1.35; }
    .count{
      white-space:nowrap;
      border:1px solid var(--border);
      border-radius:999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      background:#fff;
      align-self:flex-start;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .top{ display:flex; justify-content:flex-start; align-items:flex-start; gap: 12px; }
    .titleBlock{ min-width:0; display:flex; flex-direction:column; gap: 6px; }
    .titleBlock .t{
      margin:0;
      font-weight: 900;
      font-size: 15.5px;
      line-height: 1.25;
      letter-spacing: .2px;
      color: var(--text);
    }

    .titleAccent{ position:relative; padding-left:10px; }
    .titleAccent::before{
      content:"";
      position:absolute;
      left:0; top:2px; bottom:2px;
      width:3px;
      border-radius:2px;
      background: var(--primary);
      opacity:.75;
    }

    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px 12px;
      margin: 0;
      align-items:center;
    }
    .metaItem{
      display:inline-flex;
      gap: 6px;
      align-items:baseline;
      color: var(--muted);
      font-size: 12.6px;
      line-height: 1.35;
    }
    .metaItem b{ color: var(--text); font-weight: 800; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      background:#fff;
      white-space:nowrap;
      color: var(--text);
      align-self:flex-start;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background:#fff;
      color:var(--muted);
      width: fit-content;
    }

    .section{
      border:1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      overflow:hidden;
      background: rgba(255,255,255,.55);
    }

    .row{
      padding: 10px 12px;
      border-top: 1px solid rgba(0,0,0,.06);
      background: transparent;
    }
    .row:first-child{ border-top:none; }

    .label{ margin:0 0 6px; font-size: 12px; color: var(--muted); }
    .value{ font-size: 12.8px; line-height: 1.45; color: var(--text); }

    .chipsLine{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .chip{
      display:inline-flex;
      align-items:center;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background:#fff;
      font-weight: 700;
    }

    .chip-apueston{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }
    .chip-metabet{ border-color:#bfdbfe; background:#eff6ff; color:#1d4ed8; }
    .chip-ppp{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .chip-otros{ border-color:#fde68a; background:#fffbeb; color:#92400e; }
    .chip-blocked{ border-color:#e5e7eb; background:#f3f4f6; color:#6b7280; }

    .box{
      border: 1px solid var(--border);
      background:#f9fafb;
      border-radius: 12px;
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-top: 6px;
    }

    .mono{ font-variant-numeric: tabular-nums; }

    .actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      cursor:pointer;
      font-weight: 850;
    }
    .btn-primary{ background: var(--primary); color:#fff; }
    .btn-primary:hover{ background: var(--primary2); }
    .btn-primary:active{ transform: translateY(1px); }
    .btn-primary[disabled]{ opacity:.55; cursor:not-allowed; }

    .btn-ghost{ background:#fff; border:1px solid var(--border); color: var(--text); }

    .btn-danger{ background:#111827; color:#fff; }
    .btn-danger:hover{ background:#0b1220; }
    .btn-danger:active{ transform: translateY(1px); }

    .panel{
      display:none;
      border: 1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      padding: 12px;
      gap: 10px;
    }
    .panel.show{ display:grid; }

    .panelGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .panelGrid{ grid-template-columns: 1fr; }
    }

    input, select{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.6);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    }

    .note{ font-size: 12.5px; color: var(--muted); line-height: 1.35; }

    .warn{
      margin-top:6px;
      font-size: 12.5px;
      color: #92400e;
      background:#fffbeb;
      border:1px solid #fde68a;
      border-radius: 12px;
      padding: 10px;
      line-height: 1.35;
      display:none;
    }
    .warn.show{ display:block; }

    .confirmBox{
      display:none;
      margin-top: 6px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background:#f9fafb;
      font-size: 12.8px;
      line-height: 1.45;
    }
    .confirmBox.show{ display:block; }

    .empty{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Promociones</h1>
        <p>Activa promociones disponibles o finaliza las que ya tienes activas (incluye promociones de registro).</p>
      </div>
      <div class="count" id="countPill">0 promos</div>
    </div>

    <div id="content"></div>
  </div>

  <script>
    try { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } catch {}

    // IDs de plataforma (Nro), ya mapeados por backend
    const PLATAFORMAS = {
      1: "Apueston",
      2: "Metabet",
      3: "PPP US",
      4: "PPP SOL",
      5: "KKK",
      6: "PPP BOL",
      7: "GGG",
      8: "Tienda",
      9: "Imperial"
    };

    const PROMO_TIPO = { RECARGA: 1, REGISTRO: 2 };

    function platformName(id){ return PLATAFORMAS[id] ?? "Plataforma"; }
    function platformClass(id){
      if (id === 1) return "chip-apueston";
      if (id === 2) return "chip-metabet";
      if (id === 3 || id === 4 || id === 6) return "chip-ppp";
      return "chip-otros";
    }

    function titleCaseEs(str){
      if (!str) return "";
      return String(str)
        .trim()
        .toLowerCase()
        .replace(/(^|\s|[-_./])(\p{L})/gu, (m, sep, ch) => sep + ch.toUpperCase());
    }

    function fmtMoney(n){
      if (n === null || n === undefined || isNaN(Number(n))) return "—";
      return Number(n).toLocaleString("es-BO", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function fmtPct(n){
      if (n === null || n === undefined || isNaN(Number(n))) return "—";
      return `${Number(n).toLocaleString("es-BO", { maximumFractionDigits: 2 })}%`;
    }

    function parseJsonParam(paramName){
      const usp = new URLSearchParams(location.search);
      const raw = usp.get(paramName);
      if (!raw) return null;
      try { return JSON.parse(decodeURIComponent(raw)); } catch { return null; }
    }

    // promos: activables (solo Recarga)
    const promociones = parseJsonParam("promos") ?? [];

    // bloqueadas: Nro de plataformas ocupadas (incluye registro)
    const bloqueadas = parseJsonParam("bloqueadas") ?? [];
    const bloqueadasSet = new Set((Array.isArray(bloqueadas) ? bloqueadas : []).map(x => Number(x)));

    // promosActivas: ids de promo activas
    const promosActivas = parseJsonParam("promosActivas") ?? [];
    const promosActivasSet = new Set((Array.isArray(promosActivas) ? promosActivas : []).map(x => Number(x)));

    // promosActivasDet: detalle (Recarga y Registro)
    // OPCIONAL extra: si backend lo envía, aquí también pueden venir los datos de ClientePromocion:
    // { baseMonto: 10, productoPromocionId: 9 } para registro, etc.
    const promosActivasDet = parseJsonParam("promosActivasDet") ?? [];
    const promosActivasDetArr = Array.isArray(promosActivasDet) ? promosActivasDet : [];
    // === DEBUG LOGS (pon esto aquí) ===
console.log("URL length:", location.href.length);
console.log("URL:", location.href);

const uspDbg = new URLSearchParams(location.search);
console.log("has promos?", uspDbg.has("promos"));
console.log("raw promos length:", (uspDbg.get("promos") || "").length);
console.log("raw promos head:", (uspDbg.get("promos") || "").slice(0, 120));

console.log("promociones count:", (promociones || []).length);
console.log("bloqueadas:", bloqueadas);
console.log("promosActivas:", promosActivas);
console.log("promosActivasDet count:", (promosActivasDetArr || []).length);
console.log("promosActivasDet ids:", promosActivasDetArr.map(x => x?.Id ?? x?.id));
// === END DEBUG LOGS ===

    function sendToBot(payload){
      try { Telegram.WebApp.sendData(payload); }
      catch { alert("No se pudo enviar al bot. Abre esta MiniApp dentro de Telegram."); }
    }

    function pick(obj, ...keys){
      for (const k of keys){
        if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] !== undefined && obj[k] !== null)
          return obj[k];
      }
      return undefined;
    }

    function normalizePromo(obj){
      const promo = obj ?? {};
      const rawParams = pick(promo, "Parametros", "parametros", "ParametrosModel", "parametrosModel") ?? promo;

      // "ClientePromocion" opcional para promos activas (muy recomendado para cálculos exactos)
      // Espera algo como:
      //   Cliente = { ... }
      //   ClientePromoParametros = { monto: 10, productoPromocionId: 9, type:2 }
      // o:
      //   BaseMonto = 10, ProductoPromocionId = 9 (ya "Nro")
      const rawClienteParams =
        pick(promo, "ClientePromocion", "clientePromocion", "ClientePromo", "clientePromo", "ClientePromoParametros", "clientePromoParametros") ??
        pick(promo, "ClienteParametros", "clienteParametros");

      const p = {
        Type: Number(pick(rawParams, "Type", "type") ?? 0),
        ProductoRegaloId: Number(pick(rawParams, "ProductoRegaloId", "productoRegaloId") ?? 0),
        ProductosPromocionId: pick(rawParams, "ProductosPromocionId", "productosPromocionId"),
        MontoMinimo: Number(pick(rawParams, "MontoMinimo", "montoMinimo") ?? 0),

        MontoRegalo: Number(pick(rawParams, "MontoRegalo", "montoRegalo") ?? 0),
        MontoRegaloEsPorcentaje: !!pick(rawParams, "MontoRegaloEsPorcentaje", "montoRegaloEsPorcentaje"),

        MontoMinimoFinalizar: Number(pick(rawParams, "MontoMinimoFinalizar", "montoMinimoFinalizar") ?? 0),
        MontoMinimoFinalizarEsPorcentaje: !!pick(rawParams, "MontoMinimoFinalizarEsPorcentaje", "montoMinimoFinalizarEsPorcentaje"),

        MontoRequeridoFinalizar: Number(pick(rawParams, "MontoRequeridoFinalizar", "montoRequeridoFinalizar") ?? 0),
        MontoRequeridoFinalizarEsPorcentaje: !!pick(rawParams, "MontoRequeridoFinalizarEsPorcentaje", "montoRequeridoFinalizarEsPorcentaje"),

        // Campos opcionales de instancia (ClientePromocion):
        // Para Registro: baseMonto = bono real abonado (monto)
        // Para Recarga: baseMonto = total abonado al usuario (recarga + bono) si aplica
        BaseMonto: Number(pick(rawClienteParams, "BaseMonto", "baseMonto", "monto", "Monto") ?? NaN),
        ProductoPromocionId: Number(pick(rawClienteParams, "ProductoPromocionId", "productoPromocionId") ?? NaN),
        RecargaMonto: Number(pick(rawClienteParams, "RecargaMonto", "recargaMonto") ?? NaN)
      };

      const ids = p.ProductosPromocionId;
      if (!Array.isArray(ids)) p.ProductosPromocionId = [];

      return { promo, p };
    }

    function getValidIds(p){
      return Array.isArray(p?.ProductosPromocionId) ? p.ProductosPromocionId.map(Number) : [];
    }

    function computeGiftAmount(param, recargaMonto){
      const r = Number(recargaMonto);
      const giftVal = Number(param.MontoRegalo);
      if (isNaN(giftVal)) return null;

      if (param.MontoRegaloEsPorcentaje === true){
        if (isNaN(r) || r <= 0) return null;
        return r * (giftVal / 100);
      }
      return giftVal;
    }

    // Base para condiciones:
    // - Registro: base = bono real abonado (ClientePromocion.monto)
    // - Recarga: base = recarga + bono (total abonado), porque tus reglas indican que el usuario recibe recarga+bono
    //   y tú quieres que el % se calcule sobre ese total.
    function getBaseForFinalize(param, isRegistro, recargaMonto, baseMontoFromServer){
      // Si backend te manda BaseMonto (ideal), úsalo primero.
      const baseSrv = Number(baseMontoFromServer);
      if (!isNaN(baseSrv) && baseSrv >= 0) return baseSrv;

      if (isRegistro){
        // Fallback: si no vino, usamos MontoRegalo como aproximación (regla) aunque no siempre es exacta
        return Number(param.MontoRegalo) || 0;
      }

      // Recarga: necesitamos monto de recarga + bono
      const r = Number(recargaMonto);
      const gift = computeGiftAmount(param, r) ?? 0;
      if (!isNaN(r) && r > 0) return r + gift;

      // si no hay recargaMonto, al menos no romper:
      return 0;
    }

    function computeThresholdAbs(valor, esPorcentaje, base){
      const v = Number(valor);
      const b = Number(base);

      if (isNaN(v)) return null;

      if (esPorcentaje === true){
        if (isNaN(b) || b < 0) return null;
        return b * (v / 100);
      }
      return v;
    }

    function finalizeLinesAbs(param, isRegistro, recargaMonto, baseMontoFromServer){
      const base = getBaseForFinalize(param, isRegistro, recargaMonto, baseMontoFromServer);

      const minAbs = computeThresholdAbs(param.MontoRequeridoFinalizar, !!param.MontoRequeridoFinalizarEsPorcentaje, base);
      const maxAbs = computeThresholdAbs(param.MontoMinimoFinalizar, !!param.MontoMinimoFinalizarEsPorcentaje, base);

      return {
        base,
        minAbs,
        maxAbs
      };
    }

    function giftBadgeText(param){
      const regaloId = Number(param.ProductoRegaloId || 0);
      const plat = regaloId > 0 ? platformName(regaloId) : "—";
      const val = param.MontoRegaloEsPorcentaje ? fmtPct(param.MontoRegalo) : fmtMoney(param.MontoRegalo);
      return `Regalo: <b>${val}</b> · Acredita en <b>${plat}</b>`;
    }

    function mergePromosForUserView(){
      const byId = new Map();
      const listA = Array.isArray(promociones) ? promociones : [];
      const listB = Array.isArray(promosActivasDetArr) ? promosActivasDetArr : [];

      for (const item of [...listA, ...listB]){
        const id = Number(item?.Id ?? item?.id ?? 0);
        if (!id) continue;
        if (!byId.has(id)) byId.set(id, item);
        else {
          const prev = byId.get(id);
          const prevHas = !!(prev?.Parametros || prev?.parametros || prev?.ParametrosModel || prev?.parametrosModel);
          const curHas  = !!(item?.Parametros || item?.parametros || item?.ParametrosModel || item?.parametrosModel);
          if (!prevHas && curHas) byId.set(id, item);
        }
      }
      return Array.from(byId.values());
    }

    function renderPromoCard(item, idx){
      const { promo, p } = normalizePromo(item);

      const promoId = Number(promo?.Id ?? promo?.id ?? 0);
      const promoNombre = titleCaseEs(promo?.Nombre ?? promo?.nombre ?? "Promoción");

      const promoType = Number(p.Type || 0);
      const isRegistro = promoType === PROMO_TIPO.REGISTRO;
      const isRecarga  = promoType === PROMO_TIPO.RECARGA;

      const isTakenByUser = promosActivasSet.has(promoId);

      const showFinish = isRegistro ? true : isTakenByUser;
      const showActivate = isRecarga && !isTakenByUser;

      const validIds = showActivate ? getValidIds(p) : [];
      const disponibles = validIds.filter(id => !bloqueadasSet.has(Number(id)));
      const allBlocked = validIds.length > 0 && disponibles.length === 0;

      const chipsHtml = validIds.map(id => {
        const isBlocked = bloqueadasSet.has(Number(id));
        const cls = isBlocked ? "chip-blocked" : platformClass(id);
        const label = platformName(id) + (isBlocked ? " (ocupada)" : "");
        return `<span class="chip ${cls}">${label}</span>`;
      }).join("");

      const regaloId = Number(p.ProductoRegaloId || 0);

      // Para Registro:
      // - baseMonto ideal viene de ClientePromocion.Parametros.monto (abonado real)
      // - productoPromocionId ideal viene de ClientePromocion.Parametros.productoPromocionId (donde se abonó)
      const baseMontoRegistro = !isNaN(p.BaseMonto) ? p.BaseMonto : NaN;
      const productoPromocionId = !isNaN(p.ProductoPromocionId) ? p.ProductoPromocionId : NaN;

      const card = document.createElement("div");
      card.className = "card";

      // Texto de finalización: en vez de "200% de la recarga", mostramos Bs calculado con la base.
      // - Registro: base = bono abonado
      // - Recarga: en preview usaremos base = recarga + bono; aquí sin monto recarga no se puede fijar Bs final,
      //   pero para el usuario es mejor mostrar regla y decir que el cálculo se verá al elegir monto.
      let finalizeBlockHtml = "";
      if (isRegistro){
        const { base, minAbs, maxAbs } = finalizeLinesAbs(p, true, NaN, baseMontoRegistro);
        finalizeBlockHtml = `
          <div class="box">
            <div><b>Mayor o igual:</b> <b class="mono">${(minAbs === null ? "—" : fmtMoney(minAbs))} Bs</b></div>
            <div><b>Menor o igual:</b> <b class="mono">${(maxAbs === null ? "—" : fmtMoney(maxAbs))} Bs</b></div>
            <div class="note" style="margin-top:4px">Cálculo basado en el bono abonado: <b class="mono">${fmtMoney(base)} Bs</b></div>
          </div>
        `;
      } else {
        // Recarga: mostramos la regla, y en la confirmación mostramos Bs exacto (base = recarga + bono)
        const minRule = p.MontoRequeridoFinalizarEsPorcentaje ? `${fmtPct(p.MontoRequeridoFinalizar)} del total abonado` : `${fmtMoney(p.MontoRequeridoFinalizar)} Bs`;
        const maxRule = p.MontoMinimoFinalizarEsPorcentaje ? `${fmtPct(p.MontoMinimoFinalizar)} del total abonado` : `${fmtMoney(p.MontoMinimoFinalizar)} Bs`;

        finalizeBlockHtml = `
          <div class="box">
            <div><b>Mayor o igual:</b> ${minRule}</div>
            <div><b>Menor o igual:</b> ${maxRule}</div>
          </div>
        `;
      }

      const acreditaEnRegistro = (!isNaN(productoPromocionId) && productoPromocionId > 0)
        ? platformName(productoPromocionId)
        : (regaloId > 0 ? platformName(regaloId) : "—");

      const bonoMostrado = isRegistro
        ? (!isNaN(baseMontoRegistro) ? baseMontoRegistro : (Number(p.MontoRegalo) || 0))
        : null;

      card.innerHTML = `
        <div class="top">
          <div class="titleBlock">
            <p class="t titleAccent">${promoNombre}</p>

            ${isRegistro ? `<div class="pill">Promoción de registro (se aplica automáticamente)</div>` : ""}

            <div class="badge">${giftBadgeText(p)}</div>

            <div class="metaRow">
              <div class="metaItem">
                <span>Acredita en:</span>
                <b>${acreditaEnRegistro}</b>
              </div>

              ${
                isRegistro
                  ? `<div class="metaItem"><span>Bono abonado:</span><b class="mono">${fmtMoney(bonoMostrado)} Bs</b></div>`
                  : `<div class="metaItem"><span>Monto mínimo:</span><b class="mono">${fmtMoney(p.MontoMinimo)} Bs</b></div>`
              }
            </div>
          </div>
        </div>

        <div class="section">
          ${
            showActivate
              ? `
                <div class="row">
                  <p class="label">Aplica a:</p>
                  <div class="value">
                    <div class="chipsLine">${chipsHtml || `<span class="chip chip-otros">—</span>`}</div>
                  </div>
                </div>
              `
              : ""
          }

          <div class="row">
            <p class="label">Condición para finalizar:</p>
            <div class="value">${finalizeBlockHtml}</div>
          </div>
        </div>

        <div class="actions">
          ${showFinish ? `<button class="btn btn-danger" id="finish_${idx}">Finalizar promoción</button>` : ""}
          ${showActivate ? `<button class="btn btn-primary" id="activate_${idx}" ${allBlocked ? "disabled" : ""}>Activar promoción</button>` : ""}
        </div>

        ${
          showActivate
            ? `
              <div class="warn" id="warn_${idx}">
                No puedes activar esta promoción porque todas las plataformas aplicables ya tienen una promoción activa.
              </div>

              <div class="panel" id="panel_${idx}">
                <div class="panelGrid">
                  <div>
                    <div class="note" style="margin-bottom:6px">Monto a cargar</div>
                    <input type="number" inputmode="decimal" placeholder="Ej: 100" id="monto_${idx}">
                  </div>
                  <div>
                    <div class="note" style="margin-bottom:6px">Plataforma (solo disponibles)</div>
                    <select id="plat_${idx}">
                      ${
                        (disponibles.length ? disponibles : []).map(id => `<option value="${id}">${platformName(id)}</option>`).join("")
                      }
                    </select>
                  </div>
                </div>

                <div class="actions" style="justify-content:space-between">
                  <button class="btn btn-ghost" id="cancel_${idx}">Cancelar</button>
                  <button class="btn btn-primary" id="preview_${idx}">Continuar</button>
                </div>

                <div class="confirmBox" id="confirm_${idx}"></div>

                <div class="actions" id="confirmActions_${idx}" style="display:none">
                  <button class="btn btn-ghost" id="back_${idx}">Atrás</button>
                  <button class="btn btn-primary" id="send_${idx}">Confirmar y enviar</button>
                </div>
              </div>
            `
            : ""
        }
      `;

      // Finalizar
      const btnFinish = card.querySelector(`#finish_${idx}`);
      btnFinish?.addEventListener("click", () => {
        const payload = { event: "promo_finish", promoId: promoId };
        sendToBot(JSON.stringify(payload));
      });

      if (!showActivate) return card;

      const panel = card.querySelector(`#panel_${idx}`);
      const warn = card.querySelector(`#warn_${idx}`);
      const btnActivate = card.querySelector(`#activate_${idx}`);

      const btnCancel = card.querySelector(`#cancel_${idx}`);
      const btnPreview = card.querySelector(`#preview_${idx}`);
      const boxConfirm = card.querySelector(`#confirm_${idx}`);
      const confirmActions = card.querySelector(`#confirmActions_${idx}`);
      const btnBack = card.querySelector(`#back_${idx}`);
      const btnSend = card.querySelector(`#send_${idx}`);

      const inpMonto = card.querySelector(`#monto_${idx}`);
      const selPlat = card.querySelector(`#plat_${idx}`);

      function hideConfirm(){
        boxConfirm.classList.remove("show");
        boxConfirm.innerHTML = "";
        confirmActions.style.display = "none";
      }

      if (allBlocked) warn.classList.add("show");

      btnActivate?.addEventListener("click", () => {
        if (allBlocked) return;
        panel.classList.add("show");
        hideConfirm();
        inpMonto.focus();
      });

      btnCancel?.addEventListener("click", () => {
        panel.classList.remove("show");
        hideConfirm();
      });

      btnBack?.addEventListener("click", () => hideConfirm());

      btnPreview?.addEventListener("click", () => {
        const recarga = Number(inpMonto.value);
        if (isNaN(recarga) || recarga <= 0){
          boxConfirm.classList.add("show");
          boxConfirm.innerHTML = `Ingresa un <b>monto válido</b> mayor a 0.`;
          confirmActions.style.display = "none";
          return;
        }

        const minStart = Number(p.MontoMinimo);
        if (!isNaN(minStart) && recarga < minStart){
          boxConfirm.classList.add("show");
          boxConfirm.innerHTML = `El monto mínimo para iniciar esta promoción es <b class="mono">${fmtMoney(minStart)} Bs</b>.`;
          confirmActions.style.display = "none";
          return;
        }

        const platId = Number(selPlat.value);
        if (!platId || isNaN(platId)){
          boxConfirm.classList.add("show");
          boxConfirm.innerHTML = `Selecciona una plataforma válida.`;
          confirmActions.style.display = "none";
          return;
        }

        if (bloqueadasSet.has(platId)){
          boxConfirm.classList.add("show");
          boxConfirm.innerHTML = `Esa plataforma ya tiene una promoción activa. Elige otra plataforma.`;
          confirmActions.style.display = "none";
          return;
        }

        // NUEVO: base de cálculo para finalizar = recarga + bono (total abonado)
        const bono = computeGiftAmount(p, recarga) ?? 0;
        const totalAbonado = recarga + bono;

        const { base, minAbs, maxAbs } = finalizeLinesAbs(p, false, recarga, totalAbonado);

        const minLine = (minAbs === null) ? "—" : `<b class="mono">${fmtMoney(minAbs)} Bs</b>`;
        const maxLine = (maxAbs === null) ? "—" : `<b class="mono">${fmtMoney(maxAbs)} Bs</b>`;

        boxConfirm.classList.add("show");
        boxConfirm.innerHTML = `
          <b>Confirmación</b><br/>
          Promoción: <b>${promoNombre}</b><br/>
          Plataforma: <b>${platformName(platId)}</b><br/>
          Acredita en: <b>${regaloId > 0 ? platformName(regaloId) : "—"}</b><br/><br/>

          Cargarás <b class="mono">${fmtMoney(recarga)} Bs</b>.<br/>
          Bono: <b class="mono">${fmtMoney(bono)} Bs</b>.<br/>
          Total abonado: <b class="mono">${fmtMoney(totalAbonado)} Bs</b>.<br/><br/>

          <b>Condición para finalizar (calculada con el total abonado):</b><br/>
          • <b>Mayor o igual:</b> ${minLine}<br/>
          • <b>Menor o igual:</b> ${maxLine}
        `;

        confirmActions.style.display = "flex";
      });

      btnSend?.addEventListener("click", () => {
        const payload = {
          event: "promo_activate",
          promoId: promoId,
          monto: Number(inpMonto.value) || 0,
          plataformaId: Number(selPlat.value) || 0
        };
        sendToBot(JSON.stringify(payload));
      });

      return card;
    }

    function render(){
      const content = document.getElementById("content");
      const lista = mergePromosForUserView();

      document.getElementById("countPill").textContent = `${lista.length} promo${lista.length===1?"":"s"}`;

      if ((!Array.isArray(lista) || lista.length === 0) && promosActivasSet.size === 0){
        content.innerHTML = `<div class="empty">No hay promociones para mostrar en este momento.</div>`;
        return;
      }

      if (promosActivasSet.size > 0 && promosActivasDetArr.length === 0){
        content.innerHTML = `
          <div class="empty">
            Tienes una promoción activa, pero falta información para mostrarla aquí.<br/><br/>
            Intenta nuevamente desde el bot.
          </div>
        `;
        return;
      }

      const grid = document.createElement("div");
      grid.className = "grid";
      lista.forEach((p, i) => grid.appendChild(renderPromoCard(p, i)));

      content.innerHTML = "";
      content.appendChild(grid);
    }

    render();
  </script>
</body>
</html>
