<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promociones</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;

      --primary:#2563eb;
      --primary2:#1d4ed8;

      --shadow:0 10px 22px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 980px;
      margin:0 auto;
      padding: 16px;
    }

    .header{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      margin-bottom: 12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .header h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .header p{
      margin:6px 0 0;
      color:var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .count{
      white-space:nowrap;
      border:1px solid var(--border);
      border-radius:999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      background:#fff;
      align-self:flex-start;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .top{
      display:flex;
      justify-content:flex-start;
      align-items:flex-start;
      gap: 12px;
    }

    .titleBlock{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .titleBlock .t{
      margin:0;
      font-weight: 900;
      font-size: 15.5px;
      line-height: 1.25;
      letter-spacing: .2px;
      color: var(--text);
    }

    .titleAccent{
      position:relative;
      padding-left:10px;
    }
    .titleAccent::before{
      content:"";
      position:absolute;
      left:0;
      top:2px;
      bottom:2px;
      width:3px;
      border-radius:2px;
      background: var(--primary);
      opacity:.75;
    }

    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px 12px;
      margin: 0;
      align-items:center;
    }
    .metaItem{
      display:inline-flex;
      gap: 6px;
      align-items:baseline;
      color: var(--muted);
      font-size: 12.6px;
      line-height: 1.35;
    }
    .metaItem b{
      color: var(--text);
      font-weight: 800;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      background:#fff;
      white-space:nowrap;
      color: var(--text);
      align-self:flex-start;
    }

    .badge-muted{
      color: var(--muted);
      background:#fff;
    }

    .section{
      border:1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      overflow:hidden;
      background: rgba(255,255,255,.55);
    }

    .row{
      padding: 10px 12px;
      border-top: 1px solid rgba(0,0,0,.06);
      background: transparent;
    }
    .row:first-child{ border-top:none; }

    .label{
      margin:0 0 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .value{
      font-size: 12.8px;
      line-height: 1.45;
      color: var(--text);
    }

    .chipsLine{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background:#fff;
      font-weight: 700;
    }

    .chip-apueston{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }
    .chip-metabet{ border-color:#bfdbfe; background:#eff6ff; color:#1d4ed8; }
    .chip-ppp{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .chip-otros{ border-color:#fde68a; background:#fffbeb; color:#92400e; }
    .chip-blocked{
      border-color:#e5e7eb;
      background:#f3f4f6;
      color:#6b7280;
    }

    .box{
      border: 1px solid var(--border);
      background:#f9fafb;
      border-radius: 12px;
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-top: 6px;
    }

    .mono{ font-variant-numeric: tabular-nums; }

    .actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      cursor:pointer;
      font-weight: 850;
    }
    .btn-primary{
      background: var(--primary);
      color:#fff;
    }
    .btn-primary:hover{ background: var(--primary2); }
    .btn-primary:active{ transform: translateY(1px); }
    .btn-primary[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }

    .btn-ghost{
      background:#fff;
      border:1px solid var(--border);
      color: var(--text);
    }

    /* Botón finalizar (sobrio, pero claramente distinto) */
    .btn-danger{
      background:#111827;
      color:#fff;
    }
    .btn-danger:hover{ background:#0b1220; }
    .btn-danger:active{ transform: translateY(1px); }

    .panel{
      display:none;
      border: 1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      padding: 12px;
      gap: 10px;
    }
    .panel.show{ display:grid; }

    .panelGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .panelGrid{ grid-template-columns: 1fr; }
    }

    input, select{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.6);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    }

    .note{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }

    .warn{
      margin-top:6px;
      font-size: 12.5px;
      color: #92400e;
      background:#fffbeb;
      border:1px solid #fde68a;
      border-radius: 12px;
      padding: 10px;
      line-height: 1.35;
      display:none;
    }
    .warn.show{ display:block; }

    .confirmBox{
      display:none;
      margin-top: 6px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background:#f9fafb;
      font-size: 12.8px;
      line-height: 1.45;
    }
    .confirmBox.show{ display:block; }

    .empty{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .card.card-theme-1{ background:#ffffff; border-color:#e5e7eb; }
    .card.card-theme-2{ background:#f1f5ff; border-color:#c7d2fe; }
    .card.card-theme-3{ background:#f6f7f9; border-color:#e5e7eb; }
    .card.card-theme-4{ background:#fff7e6; border-color:#fcd34d; }
    .card.card-theme-5{ background:#eefdf3; border-color:#86efac; }

    .card.card-theme-4 .row{ background:#fffdf4; }
    .card.card-theme-5 .row{ background:#f7fff9; }

    .card.card-theme-2 .badge{ background:#eff6ff; }
    .card.card-theme-4 .badge{ background:#fffbeb; }
    .card.card-theme-5 .badge{ background:#f0fdf4; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Promociones</h1>
        <p>
          Puedes activar promos de <b>recarga</b> (una por plataforma). Si ya tienes una promo activa, podrás
          <b>finalizarla</b> aquí. Las promos de <b>registro</b> no se activan: solo se muestran para finalizar.
        </p>
      </div>
      <div class="count" id="countPill">0</div>
    </div>

    <div id="content"></div>
  </div>

  <script>
    try { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } catch {}

    const PLATAFORMAS = {
      1: "Apueston",
      2: "Metabet",
      3: "PPP US",
      4: "PPP SOL",
      5: "KKK",
      6: "PPP BOL",
      7: "GGG",
      8: "Tienda"
    };

    // IMPORTANTE:
    // El backend ahora envía:
    // - promos         => SOLO promos activables (Recarga)
    // - bloqueadas     => plataformas ocupadas por promos activas (Recarga o Registro)
    // - promosActivas  => ids de promos activas del usuario (Recarga o Registro)
    //
    // Por lo tanto, para poder FINALIZAR promos tipo Registro, la miniapp debe
    // "materializarlas" a partir de promosActivas. Para eso necesitamos conocer
    // el detalle de cada promo activa. Como el backend NO lo envía en promos,
    // la miniapp recibirá un parámetro opcional:
    //   - promosActivasDetalle: lista JSON de promociones (mismo formato PromoMiniAppDto)
    // Si no llega, igualmente se podrá enviar "promo_finish" con promoId, pero NO se podrá
    // renderizar la tarjeta con datos completos (se mostrará una tarjeta mínima).

    function platformName(id){ return PLATAFORMAS[id] ?? `Producto ${id}`; }
    function platformClass(id){
      if (id === 1) return "chip-apueston";
      if (id === 2) return "chip-metabet";
      if (id === 3 || id === 4 || id === 6) return "chip-ppp";
      return "chip-otros";
    }

    function titleCaseEs(str){
      if (!str) return "";
      return String(str)
        .trim()
        .toLowerCase()
        .replace(/(^|\s|[-_./])(\p{L})/gu, (m, sep, ch) => sep + ch.toUpperCase());
    }

    function fmtMoney(n){
      if (n === null || n === undefined || isNaN(Number(n))) return "—";
      return Number(n).toLocaleString("es-BO", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function fmtPct(n){
      if (n === null || n === undefined || isNaN(Number(n))) return "—";
      return `${Number(n).toLocaleString("es-BO", { maximumFractionDigits: 2 })}%`;
    }

    function fmtDateAny(d){
      if (!d) return "—";
      const dt = new Date(d);
      if (isNaN(dt.getTime())) return String(d);
      return dt.toLocaleString("es-BO", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });
    }

    function isNoEndDate(d){
      // Maneja DateTimeOffset.MinValue serializado (varía según backend)
      // Puede venir como "0001-01-01T00:00:00+00:00" o similar.
      if (!d) return false;
      const s = String(d);
      return s.startsWith("0001-01-01");
    }

    function parseJsonParam(paramName){
      const usp = new URLSearchParams(location.search);
      const raw = usp.get(paramName);
      if (!raw) return null;
      try { return JSON.parse(decodeURIComponent(raw)); } catch { return null; }
    }

    const promociones = parseJsonParam("promos") ?? [];
    const bloqueadas = parseJsonParam("bloqueadas") ?? [];
    const bloqueadasSet = new Set((Array.isArray(bloqueadas) ? bloqueadas : []).map(x => Number(x)));

    // Lista de promoId activas del usuario (Recarga o Registro)
    const promosActivas = parseJsonParam("promosActivas") ?? [];
    const promosActivasSet = new Set((Array.isArray(promosActivas) ? promosActivas : []).map(x => Number(x)));

    // Opcional (pero recomendado):
    // Detalle de promos activas del usuario para poder mostrar también las de Registro.
    // Formato: array de PromoMiniAppDto (Id, Nro, Nombre, FechaInicio, FechaFin, Parametros)
    const promosActivasDetalle = parseJsonParam("promosActivasDetalle") ?? [];
    const detalleById = new Map(
      (Array.isArray(promosActivasDetalle) ? promosActivasDetalle : [])
        .map(x => [Number(x?.Id ?? 0), x])
        .filter(([id]) => id > 0)
    );

    function computeThreshold(valor, esPorcentaje, recarga){
      const v = Number(valor);
      const r = Number(recarga);
      if (isNaN(v)) return null;

      if (esPorcentaje === true){
        if (isNaN(r) || r <= 0) return null;
        return r * (v / 100);
      }
      return v;
    }

    function computeGift(param, recarga){
      const r = Number(recarga);
      if (isNaN(r) || r <= 0) return null;

      const giftVal = Number(param.MontoRegalo);
      if (isNaN(giftVal)) return null;

      const regalo = param.MontoRegaloEsPorcentaje ? (r * (giftVal / 100)) : giftVal;
      const total = r + regalo;
      return { regalo, total };
    }

    function giftBadgeText(param, regaloPlataformaId){
      const plat = platformName(Number(regaloPlataformaId));
      const val = param.MontoRegaloEsPorcentaje ? fmtPct(param.MontoRegalo) : fmtMoney(param.MontoRegalo);
      return `Regalo: <b>${val}</b> · Acredita en <b>${plat}</b>`;
    }

    function finalizeTextLines(param){
      const minTxt = param.MontoRequeridoFinalizarEsPorcentaje
        ? `${fmtPct(param.MontoRequeridoFinalizar)} de la recarga`
        : `${fmtMoney(param.MontoRequeridoFinalizar)} Bs`;

      const maxTxt = param.MontoMinimoFinalizarEsPorcentaje
        ? `${fmtPct(param.MontoMinimoFinalizar)} de la recarga`
        : `${fmtMoney(param.MontoMinimoFinalizar)} Bs`;

      return { minTxt, maxTxt };
    }

    function sendToBot(payload){
      try {
        Telegram.WebApp.sendData(payload);
      } catch {
        alert("No se pudo enviar al bot. Abre esta MiniApp dentro de Telegram.");
      }
    }

    function getValidIds(p){
      if (Array.isArray(p?.ProductosPromocionId)) return p.ProductosPromocionId;
      if (Array.isArray(p?.ProductosValidosId)) return p.ProductosValidosId;
      return [];
    }

    function renderPromoCard(promo, idx, { forceTaken = false, forceNoActivate = false } = {}){
      const p = promo?.Parametros ?? promo;

      const promoId = Number(promo?.Id ?? 0);
      const isTakenByUser = forceTaken || promosActivasSet.has(promoId);

      const validIds = getValidIds(p);
      const regaloId = Number(p.ProductoRegaloId);

      // Para promos activables (recarga) se usan plataformas disponibles.
      // Para promos SOLO-finalizables (registro), no necesitamos activar, solo mostrar datos y bloquear.
      const disponibles = validIds.filter(id => !bloqueadasSet.has(Number(id)));
      const allBlocked = validIds.length > 0 && disponibles.length === 0;

      const chipsHtml = validIds.map(id => {
        const isBlocked = bloqueadasSet.has(Number(id));
        const cls = isBlocked ? "chip-blocked" : platformClass(id);
        const label = platformName(id) + (isBlocked ? " (ocupada)" : "");
        return `<span class="chip ${cls}">${label}</span>`;
      }).join("");

      const { minTxt, maxTxt } = finalizeTextLines(p);
      const promoNombre = titleCaseEs(promo?.Nombre ?? ("Promo #" + (idx + 1)));

      // Heurística para no mostrar "FechaFin" si viene MinValue
      const finTxt = isNoEndDate(promo?.FechaFin) ? "Sin fin" : fmtDateAny(promo?.FechaFin);

      const card = document.createElement("div");
      const themeIndex = (idx % 5) + 1;
      card.className = `card card-theme-${themeIndex}`;

      const canActivate = !forceNoActivate && !isTakenByUser;

      card.innerHTML = `
        <div class="top">
          <div class="titleBlock">
            <p class="t titleAccent">${promoNombre}</p>

            <div class="badge">${giftBadgeText(p, regaloId)}</div>

            <div class="metaRow">
              <div class="metaItem">
                <span>Vigencia:</span>
                <b>${fmtDateAny(promo?.FechaInicio)}</b>
                <span>→</span>
                <b>${finTxt}</b>
              </div>

              <div class="metaItem">
                <span>Inicia desde:</span>
                <b class="mono">${fmtMoney(p.MontoMinimo)} Bs</b>
              </div>

              <div class="metaItem">
                <span>Acredita en:</span>
                <b>${platformName(regaloId)}</b>
              </div>

              ${
                forceNoActivate
                  ? `<div class="metaItem"><span class="badge badge-muted">Solo finalizar</span></div>`
                  : ``
              }
            </div>
          </div>
        </div>

        <div class="section">
          <div class="row">
            <p class="label">Aplica a:</p>
            <div class="value">
              <div class="chipsLine">${chipsHtml || `<span class="chip chip-otros">—</span>`}</div>
            </div>
          </div>

          <div class="row">
            <p class="label">Condición para finalizar:</p>
            <div class="value">
              <div class="box">
                <div><b>Mayor o igual:</b> ${minTxt}</div>
                <div><b>Menor o igual:</b> ${maxTxt}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="actions">
          ${
            isTakenByUser
              ? `<button class="btn btn-danger" id="finish_${idx}">Finalizar promo</button>`
              : `<button class="btn btn-primary" id="activate_${idx}" ${allBlocked ? "disabled" : ""}>Activar promo</button>`
          }
        </div>

        <div class="warn" id="warn_${idx}">
          No puedes activar esta promoción porque todas las plataformas aplicables ya tienen una promo activa.
        </div>

        <div class="panel" id="panel_${idx}">
          <div class="panelGrid">
            <div>
              <div class="note" style="margin-bottom:6px">Monto a cargar</div>
              <input type="number" inputmode="decimal" placeholder="Ej: 100" id="monto_${idx}">
            </div>
            <div>
              <div class="note" style="margin-bottom:6px">Plataforma (solo disponibles)</div>
              <select id="plat_${idx}">
                ${
                  (disponibles.length ? disponibles : []).map(id => `<option value="${id}">${platformName(id)}</option>`).join("")
                }
              </select>
            </div>
          </div>

          <div class="actions" style="justify-content:space-between">
            <button class="btn btn-ghost" id="cancel_${idx}">Cancelar</button>
            <button class="btn btn-primary" id="preview_${idx}">Continuar</button>
          </div>

          <div class="confirmBox" id="confirm_${idx}"></div>

          <div class="actions" id="confirmActions_${idx}" style="display:none">
            <button class="btn btn-ghost" id="back_${idx}">Atrás</button>
            <button class="btn btn-primary" id="send_${idx}">Confirmar y enviar</button>
          </div>
        </div>
      `;

      const panel = card.querySelector(`#panel_${idx}`);
      const warn = card.querySelector(`#warn_${idx}`);

      const btnActivate = card.querySelector(`#activate_${idx}`);
      const btnFinish = card.querySelector(`#finish_${idx}`);

      const btnCancel = card.querySelector(`#cancel_${idx}`);
      const btnPreview = card.querySelector(`#preview_${idx}`);
      const boxConfirm = card.querySelector(`#confirm_${idx}`);
      const confirmActions = card.querySelector(`#confirmActions_${idx}`);
      const btnBack = card.querySelector(`#back_${idx}`);
      const btnSend = card.querySelector(`#send_${idx}`);

      const inpMonto = card.querySelector(`#monto_${idx}`);
      const selPlat = card.querySelector(`#plat_${idx}`);

      function hideConfirm(){
        boxConfirm.classList.remove("show");
        boxConfirm.innerHTML = "";
        confirmActions.style.display = "none";
      }

      if (canActivate && allBlocked) warn.classList.add("show");

      // Finalizar promo (incluye registro)
      btnFinish?.addEventListener("click", () => {
        const payload = { event: "promo_finish", promoId: promoId };
        sendToBot(JSON.stringify(payload));
      });

      // Si la tarjeta es "solo finalizar", deshabilita panel de activar por completo
      if (!canActivate){
        panel?.remove();
        warn?.remove();
        return card;
      }

      btnActivate?.addEventListener("click", () => {
        if (allBlocked) return;
        panel.classList.add("show");
        hideConfirm();
        inpMonto.focus();
      });

      btnCancel?.addEventListener("click", () => {
        panel.classList.remove("show");
        hideConfirm();
      });

      btnBack?.addEventListener("click", () => {
        hideConfirm();
      });

      btnPreview?.addEventListener("click", () => {
        const monto = Number(inpMonto.value);
        if (isNaN(monto) || monto <= 0){
          boxConfirm.classList.add("show");
          boxConfirm.innerHTML = `Ingresa un <b>monto válido</b> mayor a 0.`;
          confirmActions.style.display = "none";
          return;
        }

        const minStart = Number(p.MontoMinimo);
        if (!isNaN(minStart) && monto < minStart){
          boxConfirm.classList.add("show");
          boxConfirm.innerHTML = `El monto mínimo para iniciar esta promo es <b class="mono">${fmtMoney(minStart)} Bs</b>.`;
          confirmActions.style.display = "none";
          return;
        }

        const platId = Number(selPlat.value);
        if (!platId || isNaN(platId)){
          boxConfirm.classList.add("show");
          boxConfirm.innerHTML = `Selecciona una plataforma válida.`;
          confirmActions.style.display = "none";
          return;
        }

        if (bloqueadasSet.has(platId)){
          boxConfirm.classList.add("show");
          boxConfirm.innerHTML = `Esa plataforma ya tiene una promo activa. Elige otra plataforma disponible.`;
          confirmActions.style.display = "none";
          return;
        }

        const platName = platformName(platId);

        const minReq = computeThreshold(p.MontoRequeridoFinalizar, !!p.MontoRequeridoFinalizarEsPorcentaje, monto);
        const maxAllow = computeThreshold(p.MontoMinimoFinalizar, !!p.MontoMinimoFinalizarEsPorcentaje, monto);

        const g = computeGift(p, monto);

        const minReqLine = (minReq === null) ? `—` : `<b class="mono">${fmtMoney(minReq)}</b> Bs`;
        const maxAllowLine = (maxAllow === null) ? `—` : `<b class="mono">${fmtMoney(maxAllow)}</b> Bs`;

        const giftLine = g ? `<b class="mono">${fmtMoney(g.regalo)}</b> Bs` : `—`;
        const totalLine = g ? `<b class="mono">${fmtMoney(g.total)}</b> Bs` : `—`;

        boxConfirm.classList.add("show");
        boxConfirm.innerHTML = `
          <b>Confirmación</b><br/>
          Promo: <b>${promoNombre}</b><br/>
          Vigencia: <b>${fmtDateAny(promo?.FechaInicio)}</b> → <b>${finTxt}</b><br/>
          Regalo acredita en: <b>${platformName(regaloId)}</b><br/><br/>

          Cargarás <b class="mono">${fmtMoney(monto)} Bs</b> en <b>${platName}</b>.<br/><br/>

          <b>Regalo:</b> ${giftLine}<br/>
          <b>Total a cargar:</b> ${totalLine}<br/><br/>

          <b>Para finalizar (calculado con tu recarga):</b><br/>
          • <b>Mayor o igual:</b> ${minReqLine}<br/>
          • <b>Menor o igual:</b> ${maxAllowLine}
        `;

        confirmActions.style.display = "flex";
      });

      btnSend?.addEventListener("click", () => {
        const payload = {
          event: "promo_activate",
          promoId: promoId,
          monto: Number(inpMonto.value) || 0,
          plataformaId: Number(selPlat.value) || 0
        };
        sendToBot(JSON.stringify(payload));
      });

      return card;
    }

    function buildCardsModel(){
      // 1) Promos para activar (Recarga)
      const activables = Array.isArray(promociones) ? promociones : [];

      // 2) Promos activas del usuario (pueden incluir Registro).
      //    Si tenemos detalle, creamos tarjetas completas.
      //    Si NO tenemos detalle, mostramos una tarjeta mínima por id activo que no esté en activables.
      const cards = [];

      // Agrega activables primero
      activables.forEach(x => cards.push({ kind: "promo", data: x }));

      // PromoIds activos que no están dentro de "promos" (típicamente Registro)
      const idsEnActivables = new Set(activables.map(x => Number(x?.Id ?? 0)).filter(x => x > 0));

      const activosIds = (Array.isArray(promosActivas) ? promosActivas : [])
        .map(x => Number(x))
        .filter(x => x > 0);

      activosIds.forEach(id => {
        if (idsEnActivables.has(id)) return;

        const det = detalleById.get(id);
        if (det){
          cards.push({ kind: "active_detail", data: det });
          return;
        }

        // Fallback: tarjeta mínima (solo finalizar)
        cards.push({
          kind: "active_min",
          data: {
            Id: id,
            Nombre: `Promo activa #${id}`,
            FechaInicio: null,
            FechaFin: null,
            Parametros: { ProductoRegaloId: 0, ProductosPromocionId: [], MontoMinimo: 0,
              MontoRequeridoFinalizar: 0, MontoRequeridoFinalizarEsPorcentaje: false,
              MontoMinimoFinalizar: 0, MontoMinimoFinalizarEsPorcentaje: false,
              MontoRegalo: 0, MontoRegaloEsPorcentaje: false
            }
          }
        });
      });

      return cards;
    }

    function render(){
      const content = document.getElementById("content");

      const cardsModel = buildCardsModel();

      // Conteo útil: cuántas activables + cuántas activas (finalizables)
      const activablesCount = (Array.isArray(promociones) ? promociones.length : 0);
      const activasCount = promosActivasSet.size;

      document.getElementById("countPill").textContent =
        `${activablesCount} activable${activablesCount===1?"":"s"} · ${activasCount} activa${activasCount===1?"":"s"}`;

      if (cardsModel.length === 0){
        content.innerHTML = `
          <div class="empty">
            No se recibieron promociones.<br/><br/>
            Parámetros esperados:<br/>
            • <b>promos</b> = lista JSON de promociones activables (recarga)<br/>
            • <b>bloqueadas</b> = lista JSON de ids de plataformas ocupadas (recarga o registro)<br/>
            • <b>promosActivas</b> = lista JSON de ids de promos activas del usuario (recarga o registro)<br/><br/>
            Opcional (recomendado para mostrar promos de registro con detalle):<br/>
            • <b>promosActivasDetalle</b> = lista JSON con el detalle de promos activas del usuario
          </div>
        `;
        return;
      }

      const grid = document.createElement("div");
      grid.className = "grid";

      let idx = 0;
      cardsModel.forEach(item => {
        if (item.kind === "promo"){
          grid.appendChild(renderPromoCard(item.data, idx++, { forceTaken: false, forceNoActivate: false }));
          return;
        }

        // Promos activas que pueden ser Registro: SOLO finalizar (no activar)
        grid.appendChild(renderPromoCard(item.data, idx++, { forceTaken: true, forceNoActivate: true }));
      });

      content.innerHTML = "";
      content.appendChild(grid);
    }

    render();
  </script>
</body>
</html>
