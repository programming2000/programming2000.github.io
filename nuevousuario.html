<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nueva cuenta</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --primary:#4A90E2; --bg:#f5f8fb; --card:#fff; --text:#333; --border:#dfe6ee; --hover:#3b7dc4; --error:#d84a4a;
  }
  *{box-sizing:border-box}
  body{font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);margin:0;min-height:100vh;display:grid;place-items:center}
  .container{width:100%;max-width:420px;background:var(--card);padding:28px 22px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
  h2{margin:0 0 16px;text-align:center;color:var(--primary)}
  .section-title{font-weight:700;margin:16px 0 8px;color:#444}
  .btn{width:100%;background:var(--primary);color:#fff;border:0;padding:12px;font-size:16px;font-weight:600;border-radius:10px;cursor:pointer;transition:background-color .25s ease}
  .btn:hover{background:var(--hover)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .stack{display:grid;gap:10px}
  .row{display:flex;gap:10px;align-items:center}
  .row input{flex:1;padding:11px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px;background:#fdfdfd}
  .row input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(74,144,226,.15)}
  .small{font-size:12px;color:#666;margin-top:6px}
  .error{font-size:12px;color:var(--error);margin-top:6px;display:none}
  .divider{height:1px;background:#e6edf5;margin:14px 0}
  .selected{outline:2px solid var(--primary); outline-offset:2px}
  /* Modal */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(3px);z-index:10;align-items:center;justify-content:center}
  .modal-overlay.show{display:flex}
  .modal{background:#fff;width:min(92%,380px);padding:22px 18px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.2)}
  .modal h3{margin:0;color:var(--primary)}
  .modal p{white-space:pre-line;margin:14px 0;color:#333}
  .button-group{display:flex;gap:12px}
  .button-group button{flex:1;border:0;padding:10px;font-weight:600;border-radius:10px;cursor:pointer}
  .button-group button:first-child{background:var(--primary);color:#fff}
  .button-group button:last-child{background:#e0e6ed;color:#333}
   .row{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .row input{
    flex:1; /* toma el espacio disponible */
    padding:11px 12px;
    border:1px solid var(--border);
    border-radius:10px;
    font-size:15px;
    background:#fdfdfd;
  }
  .row input:focus{
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(74,144,226,.15);
  }
  .row .btn{
    flex:0 0 120px; /* ancho fijo para el botón */
    padding:10px;   /* más compacto */
    font-size:14px; /* texto un poco más pequeño */
  }
</style>
</head>
<body>
  <div class="container">
    <h2>Crear nueva cuenta</h2>

    <div class="section">
      <div class="section-title">Acción rápida</div>
      <div class="stack">
        <button id="btnApuestonQuick" class="btn">Nuevo Apueston</button>
        <button id="btnMetabetQuick" class="btn">Nuevo Metabet</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <div class="section-title">Crear y ligar a un username</div>
      <div class="row">
        <input id="userApueston" type="text" placeholder="username (sin @)" />
        <button id="btnApuestonLink" class="btn">Apueston</button>
      </div>
      <div id="msgApueston" class="error">Username inválido (5–32: letras, números o _), sin @.</div>

      <div class="row" style="margin-top:10px">
        <input id="userMetabet" type="text" placeholder="username (sin @)" />
        <button id="btnMetabetLink" class="btn">Metabet</button>
      </div>
      <div id="msgMetabet" class="error">Username inválido (5–32: letras, números o _), sin @.</div>

      <div class="small">Si usas estos botones, se creará un nuevo usuario y se ligará a ese username de Telegram.</div>
    </div>

    <div style="margin-top:16px">
      <button id="btnConfirm" class="btn" disabled>Confirmar</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Confirmar</h3>
      <p id="summaryText"></p>
      <div class="button-group">
        <button id="confirmYes">Sí</button>
        <button id="confirmNo">No</button>
      </div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp; if (tg){ tg.ready(); tg.expand(); }

  // Elements
  const $ = s => document.querySelector(s);
  const btnApuestonQuick = $('#btnApuestonQuick');
  const btnMetabetQuick  = $('#btnMetabetQuick');
  const userApueston     = $('#userApueston');
  const userMetabet      = $('#userMetabet');
  const btnApuestonLink  = $('#btnApuestonLink');
  const btnMetabetLink   = $('#btnMetabetLink');
  const msgApueston      = $('#msgApueston');
  const msgMetabet       = $('#msgMetabet');
  const btnConfirm       = $('#btnConfirm');

  const modalOverlay = $('#modalOverlay');
  const summaryText  = $('#summaryText');
  const confirmYes   = $('#confirmYes');
  const confirmNo    = $('#confirmNo');

  // State
  let selection = null; // { action: 'quick'|'link', platform: 'apueston'|'metabet', username?: string }

  // Helpers
  const sanitizeUsername = v => v.trim().replace(/^@+/, '');
  const isValidUsername  = v => /^[A-Za-z0-9_]{5,32}$/.test(sanitizeUsername(v));

  function clearSelectionStyles(){
    [btnApuestonQuick, btnMetabetQuick, btnApuestonLink, btnMetabetLink].forEach(b=>b.classList.remove('selected'));
  }
  function updateConfirmState(){
    btnConfirm.disabled = !selection || (selection.action==='link' && !selection.username);
  }
  function openModal(summary){
    summaryText.textContent = summary;
    modalOverlay.classList.add('show');
    modalOverlay.setAttribute('aria-hidden', 'false');
  }
  function closeModal(){
    modalOverlay.classList.remove('show');
    modalOverlay.setAttribute('aria-hidden', 'true');
  }

  // Quick actions
  btnApuestonQuick.addEventListener('click', ()=>{
    clearSelectionStyles();
    btnApuestonQuick.classList.add('selected');
    selection = { action:'quick', platform:'apueston' };
    updateConfirmState();
  });
  btnMetabetQuick.addEventListener('click', ()=>{
    clearSelectionStyles();
    btnMetabetQuick.classList.add('selected');
    selection = { action:'quick', platform:'metabet' };
    updateConfirmState();
  });

  // Link actions (with username)
  btnApuestonLink.addEventListener('click', ()=>{
    const u = sanitizeUsername(userApueston.value);
    if(!isValidUsername(u)){
      msgApueston.style.display = 'block';
      return;
    }
    msgApueston.style.display = 'none';
    clearSelectionStyles();
    btnApuestonLink.classList.add('selected');
    selection = { action:'link', platform:'apueston', username:u };
    updateConfirmState();
  });

  btnMetabetLink.addEventListener('click', ()=>{
    const u = sanitizeUsername(userMetabet.value);
    if(!isValidUsername(u)){
      msgMetabet.style.display = 'block';
      return;
    }
    msgMetabet.style.display = 'none';
    clearSelectionStyles();
    btnMetabetLink.classList.add('selected');
    selection = { action:'link', platform:'metabet', username:u };
    updateConfirmState();
  });

  // Enable live validation error hide
  [userApueston, userMetabet].forEach(inp=>{
    inp.addEventListener('input', ()=>{
      if(inp===userApueston) msgApueston.style.display='none';
      if(inp===userMetabet)  msgMetabet.style.display='none';
    });
  });

  // Confirm button -> show summary
  btnConfirm.addEventListener('click', ()=>{
    if(!selection) return;

    if(selection.action==='quick'){
      openModal(`Se creará una nueva cuenta:\nPlataforma: ${selection.platform}\n¿Confirmas?`);
    } else {
      openModal(`Se creará una nueva cuenta y se ligará al username:\nPlataforma: ${selection.platform}\nUsername: ${selection.username}\n¿Confirmas?`);
    }
  });

  // Modal actions
  confirmNo.addEventListener('click', closeModal);

  confirmYes.addEventListener('click', ()=>{
    if(!selection) return;

    const payload = {
      tipo: 'crear_cuenta',
      plataforma: selection.platform,
      ligar_username: selection.action === 'link',
      username: selection.action === 'link' ? selection.username : null
    };

    if (tg?.sendData) {
      tg.sendData(JSON.stringify(payload));
    } else {
      alert('Payload:\n' + JSON.stringify(payload, null, 2));
    }

    closeModal();
  });

  // Escape to close
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
</script>
</body>
</html>
