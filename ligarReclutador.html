<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nueva cuenta</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --primary:#4A90E2; --bg:#f5f8fb; --card:#fff; --text:#333; --border:#dfe6ee; --hover:#3b7dc4; --error:#d84a4a;
  }
  *{box-sizing:border-box}
  body{font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);margin:0;min-height:100vh;display:grid;place-items:center}
  .container{width:100%;max-width:420px;background:var(--card);padding:28px 22px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
  h2{margin:0 0 16px;text-align:center;color:var(--primary)}
  .section-title{font-weight:700;margin:16px 0 8px;color:#444}
  .btn{width:100%;background:var(--primary);color:#fff;border:0;padding:12px;font-size:16px;font-weight:600;border-radius:10px;cursor:pointer;transition:background-color .25s ease}
  .btn:hover{background:var(--hover)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .row{display:flex;gap:10px;align-items:center}
  .row input[type="text"]{flex:1;padding:11px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px;background:#fdfdfd}
  .row input[type="text"]:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(74,144,226,.15)}
  .small{font-size:12px;color:#666;margin-top:6px}
  .error{font-size:12px;color:var(--error);margin-top:6px;display:none}
  .divider{height:1px;background:#e6edf5;margin:14px 0}
  .checks{display:grid;gap:8px}
  .check{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fdfdfd;
  }
  .check input{width:18px;height:18px}
  .check label{flex:1;cursor:pointer}
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(3px);z-index:10;align-items:center;justify-content:center}
  .modal-overlay.show{display:flex}
  .modal{background:#fff;width:min(92%,380px);padding:22px 18px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.2)}
  .modal h3{margin:0;color:var(--primary)}
  .modal p{white-space:pre-line;margin:14px 0;color:#333}
  .button-group{display:flex;gap:12px}
  .button-group button{flex:1;border:0;padding:10px;font-weight:600;border-radius:10px;cursor:pointer}
  .button-group button:first-child{background:var(--primary);color:#fff}
  .button-group button:last-child{background:#e0e6ed;color:#333}
</style>
</head>
<body>
  <div class="container">
    <h2>Crear nueva cuenta</h2>

    <!-- Crear y ligar a un username -->
    <div class="section">
      <div class="section-title">Crear y ligar a un username</div>
      <div class="row">
        <input id="username" type="text" placeholder="username (sin @)" />
      </div>
      <div id="msgUsername" class="error">Username inválido (5–32: letras, números o _), sin @.</div>

      <div class="checks" style="margin-top:10px" role="group" aria-label="Ligar a plataformas">
        <div class="check">
          <input type="checkbox" id="linkApueston" />
          <label for="linkApueston">Ligar a Apueston</label>
        </div>
        <div class="check">
          <input type="checkbox" id="linkMetabet" />
          <label for="linkMetabet">Ligar a Metabet</label>
        </div>
      </div>

      <div class="small">Se creará la(s) cuenta(s) y se asociará(n) al username indicado.</div>
    </div>

    <div class="divider"></div>

    <div style="margin-top:16px">
      <button id="btnConfirm" class="btn" disabled>Confirmar</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Confirmar</h3>
      <p id="summaryText"></p>
      <div class="button-group">
        <button id="confirmYes">Sí</button>
        <button id="confirmNo">No</button>
      </div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp; if (tg){ tg.ready(); tg.expand(); }

  // Elements
  const $ = s => document.querySelector(s);
  const linkApueston  = $('#linkApueston');
  const linkMetabet   = $('#linkMetabet');
  const usernameInp   = $('#username');
  const msgUsername   = $('#msgUsername');
  const btnConfirm    = $('#btnConfirm');

  const modalOverlay  = $('#modalOverlay');
  const summaryText   = $('#summaryText');
  const confirmYes    = $('#confirmYes');
  const confirmNo     = $('#confirmNo');

  // Helpers
  const sanitizeUsername = v => v.trim().replace(/^@+/, '');
  const isValidUsername  = v => /^[A-Za-z0-9_]{5,32}$/.test(sanitizeUsername(v));

  function anySelection(){
    // Ahora solo existen las opciones de ligar
    return linkApueston.checked || linkMetabet.checked;
  }

  function needsUsername(){
    // Siempre que haya al menos una plataforma marcada, se requiere username
    return anySelection();
  }

  function updateConfirmState(){
    const hasAny = anySelection();
    const u = sanitizeUsername(usernameInp.value);
    const validU = !needsUsername() || isValidUsername(u);

    btnConfirm.disabled = !(hasAny && validU);

    // Mostrar/ocultar error en vivo
    if (needsUsername()){
      msgUsername.style.display = isValidUsername(u) ? 'none' : 'block';
    } else {
      msgUsername.style.display = 'none';
    }
  }

  // Events to recalc state
  [linkApueston, linkMetabet].forEach(chk => {
    chk.addEventListener('change', updateConfirmState);
  });
  usernameInp.addEventListener('input', updateConfirmState);

  // Modal helpers
  function openModal(text){
    summaryText.textContent = text;
    modalOverlay.classList.add('show');
    modalOverlay.setAttribute('aria-hidden', 'false');
  }
  function closeModal(){
    modalOverlay.classList.remove('show');
    modalOverlay.setAttribute('aria-hidden', 'true');
  }

  // Build summary text
  function buildSummary(){
    const u = sanitizeUsername(usernameInp.value);
    const lines = [];

    lines.push('Se realizará lo siguiente:\n');
    lines.push('• Crear y ligar cuenta(s) al username:');
    lines.push(`   - Username: ${u}`);
    if (linkApueston.checked) lines.push('   - Ligar en Apueston');
    if (linkMetabet.checked)  lines.push('   - Ligar en Metabet');
    lines.push('');

    return lines.join('\n');
  }

  // Confirm button -> show summary
  btnConfirm.addEventListener('click', ()=>{
    if (btnConfirm.disabled) return;
    if (needsUsername() && !isValidUsername(sanitizeUsername(usernameInp.value))) return;

    const summary = buildSummary();
    openModal(summary);
  });

  // Modal actions
  confirmNo.addEventListener('click', closeModal);

  confirmYes.addEventListener('click', ()=>{
    const payload = {
      tipo: 'crear_cuenta_ref',
      username: sanitizeUsername(usernameInp.value),
      apueston: { link: !!linkApueston.checked },
      metabet:  { link: !!linkMetabet.checked }
    };

    if (tg?.sendData) {
      tg.sendData(JSON.stringify(payload));
    } else {
      alert('Payload:\n' + JSON.stringify(payload, null, 2));
    }
    closeModal();
  });

  // Escape to close modal
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  // Initial state
  updateConfirmState();
</script>
</body>
</html>
